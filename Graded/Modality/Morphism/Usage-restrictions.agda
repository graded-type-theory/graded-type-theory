------------------------------------------------------------------------
-- Preserving/reflecting usage restrictions
------------------------------------------------------------------------

module Graded.Modality.Morphism.Usage-restrictions where

open import Tools.Bool
open import Tools.Empty
open import Tools.Function
open import Tools.Level
open import Tools.Product
open import Tools.PropositionalEquality
open import Tools.Relation
open import Tools.Sum

open import Graded.Modality
import Graded.Modality.Properties
open import Graded.Modality.Morphism
open import Graded.Mode
open import Graded.Usage.Erased-matches
open import Graded.Usage.Restrictions
open import Graded.Usage.Restrictions.Natrec
open import Graded.Usage.Restrictions.Instance as RI

open import Definition.Untyped.NotParametrised

private variable
  aРѓЂ aРѓѓ pРѓЂ pРѓѓ pРѓЃ           : Level
  M MРѓЂ MРѓѓ                  : Set _
  P PРѓЃ                     : M Рєњ Set _
  f fРѓЃ trРѓЂ trРѓѓ tr-╬БРѓЂ tr-╬БРѓѓ : MРѓЂ Рєњ MРѓѓ
  p q r                    : M
  ­ЮЋё ­ЮЋёРѓЂ ­ЮЋёРѓѓ ­ЮЋёРѓЃ               : Modality _
  R RРѓЂ RРѓѓ RРѓЃ               : Usage-restrictions _
  mРѓЂ mРѓѓ mРѓЃ                 : Mode _
  s                        : Strength
  РдЃ okРѓЂ okРѓѓ Рдё              : T _
  nm nmРѓЂ nmРѓѓ nmРѓЃ           : Natrec-mode _

------------------------------------------------------------------------
-- The relations _РЅѕрхљ_ and _РЅ│рхљ_

-- Two modes from two possibly different modalities are equivalent if
-- they are both ­ЮЪЎрхљ or both ­ЮЪўрхљ (with arbitrary proofs).

infix 4 _РЅѕрхљ_

data _РЅѕрхљ_
       {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
       {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ} :
       Mode ­ЮЋёРѓЂ Рєњ Mode ­ЮЋёРѓѓ Рєњ Set (aРѓЂ Ріћ aРѓѓ) where
  ­ЮЪўрхљ : ­ЮЪўрхљ[ okРѓЂ ] РЅѕрхљ ­ЮЪўрхљ[ okРѓѓ ]
  ­ЮЪЎрхљ : ­ЮЪЎрхљ        РЅѕрхљ ­ЮЪЎрхљ

-- A variant of _РЅѕрхљ_. ­ЮЪЎрхљ┬аРЅ│рхљ┬а­ЮЪўрхљ[┬аokРѓѓ┬а] is allowed if the "first"
-- modality is trivial.

infix 4 _РЅ│рхљ_

data _РЅ│рхљ_
       {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
       {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ} :
       Mode ­ЮЋёРѓЂ Рєњ Mode ­ЮЋёРѓѓ Рєњ Set (aРѓЂ Ріћ aРѓѓ) where
  [_]   : mРѓЂ РЅѕрхљ mРѓѓ Рєњ mРѓЂ РЅ│рхљ mРѓѓ
  ­ЮЪЎрхљРЅ│­ЮЪўрхљ : Modality.Trivial ­ЮЋёРѓЂ Рєњ ­ЮЪЎрхљ РЅ│рхљ ­ЮЪўрхљ[ okРѓѓ ]

opaque

  -- The relation _РЅѕрхљ_ is symmetric.

  РЅѕрхљ-symmetric : mРѓЂ РЅѕрхљ mРѓѓ Рєњ mРѓѓ РЅѕрхљ mРѓЂ
  РЅѕрхљ-symmetric ­ЮЪўрхљ = ­ЮЪўрхљ
  РЅѕрхљ-symmetric ­ЮЪЎрхљ = ­ЮЪЎрхљ

opaque

  -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ holds, then mРѓѓ┬аРЅА┬а­ЮЪЎрхљ implies mРѓЂ┬аРЅА┬а­ЮЪЎрхљ.

  РЅѕрхљРєњРЅА­ЮЪЎрхљРєњРЅА­ЮЪЎрхљ : mРѓЂ РЅѕрхљ mРѓѓ Рєњ mРѓѓ РЅА ­ЮЪЎрхљ Рєњ mРѓЂ РЅА ­ЮЪЎрхљ
  РЅѕрхљРєњРЅА­ЮЪЎрхљРєњРЅА­ЮЪЎрхљ ­ЮЪЎрхљ refl = refl
  РЅѕрхљРєњРЅА­ЮЪЎрхљРєњРЅА­ЮЪЎрхљ ­ЮЪўрхљ ()

opaque

  -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ holds, then mРѓЂ┬аРЅА┬а­ЮЪЎрхљ implies mРѓѓ┬аРЅА┬а­ЮЪЎрхљ.

  РЅѕрхљРєњРЅА­ЮЪЎрхљРєљРЅА­ЮЪЎрхљ : mРѓЂ РЅѕрхљ mРѓѓ Рєњ mРѓЂ РЅА ­ЮЪЎрхљ Рєњ mРѓѓ РЅА ­ЮЪЎрхљ
  РЅѕрхљРєњРЅА­ЮЪЎрхљРєљРЅА­ЮЪЎрхљ = РЅѕрхљРєњРЅА­ЮЪЎрхљРєњРЅА­ЮЪЎрхљ РѕўРєњ РЅѕрхљ-symmetric

private opaque

  -- Some lemmas used below.

  РЅѕрхљРєњРЅцрхЅрхљРѓЂ : mРѓЂ РЅѕрхљ mРѓѓ Рєњ f mРѓЂ РЅцрхЅрхљ f mРѓѓ
  РЅѕрхљРєњРЅцрхЅрхљРѓЂ     ­ЮЪЎрхљ = РЅцрхЅрхљ-reflexive
  РЅѕрхљРєњРЅцрхЅрхљРѓЂ {f} ­ЮЪўрхљ = subst (_РЅцрхЅрхљ_ _) (cong f (­ЮЪўрхљ-cong _)) РЅцрхЅрхљ-reflexive

  РЅѕрхљРєњРєњРѓЂ : mРѓЂ РЅѕрхљ mРѓѓ Рєњ P mРѓЂ Рєњ P mРѓѓ
  РЅѕрхљРєњРєњРѓЂ     ­ЮЪЎрхљ           = idрХа
  РЅѕрхљРєњРєњРѓЂ {P} (­ЮЪўрхљ РдЃ okРѓЂ Рдё) =
    subst (╬╗ ok Рєњ P ­ЮЪўрхљ[ okРѓЂ ] Рєњ P ­ЮЪўрхљ[ ok ]) T-propositional idрХа

  РЅ│рхљРєњРєљРѓЂ :
    {P : Mode ­ЮЋё Рєњ Set p} Рєњ
    mРѓЂ РЅ│рхљ mРѓѓ Рєњ P mРѓѓ Рєњ P mРѓЂ
  РЅ│рхљРєњРєљРѓЂ [ mРѓЂРЅѕmРѓѓ ] =
    РЅѕрхљРєњРєњРѓЂ $ РЅѕрхљ-symmetric mРѓЂРЅѕmРѓѓ
  РЅ│рхљРєњРєљРѓЂ {­ЮЋё} (­ЮЪЎрхљРЅ│­ЮЪўрхљ РдЃ okРѓѓ = ok Рдё trivial) =
    РіЦ-elim $ MP.­ЮЪўрхљ.non-trivial ok trivial
    where
    module MP = Graded.Modality.Properties ­ЮЋё

  РЅѕрхљРєњРЅцрхЅрхљРѓѓ :
    {fРѓЂ : Mode ­ЮЋёРѓЂ Рєњ Erased-matches}
    {fРѓѓ : Mode ­ЮЋёРѓѓ Рєњ Erased-matches} Рєњ
    let module MРѓЂ = Modality ­ЮЋёРѓЂ
        module MРѓѓ = Modality ­ЮЋёРѓѓ
    in
    (T MРѓЂ.­ЮЪўрхљ-allowed Рєњ T MРѓѓ.­ЮЪўрхљ-allowed) Рєњ
    (Рѕђ {mРѓЂ mРѓѓ} Рєњ mРѓЂ РЅѕрхљ mРѓѓ Рєњ fРѓЂ mРѓЂ РЅцрхЅрхљ fРѓѓ mРѓѓ) Рєњ
    (Рѕђ {mРѓѓ mРѓЃ} Рєњ mРѓѓ РЅѕрхљ mРѓЃ Рєњ fРѓѓ mРѓѓ РЅцрхЅрхљ fРѓЃ mРѓЃ) Рєњ
    mРѓЂ РЅѕрхљ mРѓЃ Рєњ fРѓЂ mРѓЂ РЅцрхЅрхљ fРѓЃ mРѓЃ
  РЅѕрхљРєњРЅцрхЅрхљРѓѓ _ hypРѓЂ hypРѓѓ ­ЮЪЎрхљ =
    РЅцрхЅрхљ-transitive (hypРѓЂ ­ЮЪЎрхљ) (hypРѓѓ ­ЮЪЎрхљ)
  РЅѕрхљРєњРЅцрхЅрхљРѓѓ ­ЮЪўрхљРєњ­ЮЪўрхљ hypРѓЂ hypРѓѓ (­ЮЪўрхљ РдЃ okРѓЂ Рдё) =
    case ­ЮЪўрхљРєњ­ЮЪўрхљ okРѓЂ of ╬╗
      okРѓѓ Рєњ
    РЅцрхЅрхљ-transitive (hypРѓЂ (­ЮЪўрхљ РдЃ okРѓѓ = okРѓѓ Рдё)) (hypРѓѓ (­ЮЪўрхљ РдЃ okРѓЂ = okРѓѓ Рдё))

  РЅѕрхљРєњРєњРѓѓ :
    {PРѓЂ : Mode ­ЮЋёРѓЂ Рєњ Set pРѓЂ}
    {PРѓѓ : Mode ­ЮЋёРѓѓ Рєњ Set pРѓѓ} Рєњ
    let module MРѓЂ = Modality ­ЮЋёРѓЂ
        module MРѓѓ = Modality ­ЮЋёРѓѓ
    in
    (T MРѓЂ.­ЮЪўрхљ-allowed Рєњ T MРѓѓ.­ЮЪўрхљ-allowed) Рєњ
    (Рѕђ {mРѓЂ mРѓѓ} Рєњ mРѓЂ РЅѕрхљ mРѓѓ Рєњ PРѓЂ mРѓЂ Рєњ PРѓѓ mРѓѓ) Рєњ
    (Рѕђ {mРѓѓ mРѓЃ} Рєњ mРѓѓ РЅѕрхљ mРѓЃ Рєњ PРѓѓ mРѓѓ Рєњ PРѓЃ mРѓЃ) Рєњ
    mРѓЂ РЅѕрхљ mРѓЃ Рєњ PРѓЂ mРѓЂ Рєњ PРѓЃ mРѓЃ
  РЅѕрхљРєњРєњРѓѓ _ hypРѓЂ hypРѓѓ ­ЮЪЎрхљ =
    hypРѓѓ ­ЮЪЎрхљ РѕўРєњ hypРѓЂ ­ЮЪЎрхљ
  РЅѕрхљРєњРєњРѓѓ ­ЮЪўрхљРєњ­ЮЪўрхљ hypРѓЂ hypРѓѓ (­ЮЪўрхљ РдЃ okРѓЂ Рдё) =
    case ­ЮЪўрхљРєњ­ЮЪўрхљ okРѓЂ of ╬╗
      okРѓѓ Рєњ
    hypРѓѓ (­ЮЪўрхљ РдЃ okРѓЂ = okРѓѓ Рдё) РѕўРєњ hypРѓЂ (­ЮЪўрхљ РдЃ okРѓѓ = okРѓѓ Рдё)

  РЅѕрхљРєњРЅЦрхЅрхљРѓѓ :
    {fРѓЂ : Mode ­ЮЋёРѓЂ Рєњ Erased-matches}
    {fРѓѓ : Mode ­ЮЋёРѓѓ Рєњ Erased-matches} Рєњ
    let module MРѓЂ = Modality ­ЮЋёРѓЂ
        module MРѓѓ = Modality ­ЮЋёРѓѓ
    in
    (T MРѓЂ.­ЮЪўрхљ-allowed Рєњ T MРѓѓ.­ЮЪўрхљ-allowed) Рєњ
    (Рѕђ {mРѓѓ mРѓЃ} Рєњ mРѓѓ РЅѕрхљ mРѓЃ Рєњ fРѓЃ mРѓЃ РЅцрхЅрхљ fРѓѓ mРѓѓ) Рєњ
    (Рѕђ {mРѓЂ mРѓѓ} Рєњ mРѓЂ РЅѕрхљ mРѓѓ Рєњ fРѓѓ mРѓѓ РЅцрхЅрхљ fРѓЂ mРѓЂ) Рєњ
    mРѓЂ РЅѕрхљ mРѓЃ Рєњ fРѓЃ mРѓЃ РЅцрхЅрхљ fРѓЂ mРѓЂ
  РЅѕрхљРєњРЅЦрхЅрхљРѓѓ _ hypРѓЂ hypРѓѓ ­ЮЪЎрхљ =
    РЅцрхЅрхљ-transitive (hypРѓЂ ­ЮЪЎрхљ) (hypРѓѓ ­ЮЪЎрхљ)
  РЅѕрхљРєњРЅЦрхЅрхљРѓѓ ­ЮЪўрхљРєњ­ЮЪўрхљ hypРѓЂ hypРѓѓ (­ЮЪўрхљ РдЃ okРѓЂ Рдё РдЃ okРѓѓ = okРѓЃ Рдё) =
    case ­ЮЪўрхљРєњ­ЮЪўрхљ okРѓЂ of ╬╗
      okРѓѓ Рєњ
    РЅцрхЅрхљ-transitive (hypРѓЂ (­ЮЪўрхљ РдЃ okРѓЂ = okРѓѓ Рдё)) (hypРѓѓ (­ЮЪўрхљ РдЃ okРѓѓ = okРѓѓ Рдё))

  РЅ│рхљРєњРєљРѓѓ :
    {PРѓЂ : Mode ­ЮЋёРѓЂ Рєњ Set pРѓЂ}
    {PРѓѓ : Mode ­ЮЋёРѓѓ Рєњ Set pРѓѓ}
    {PРѓЃ : Mode ­ЮЋёРѓЃ Рєњ Set pРѓЃ} Рєњ
    let module MРѓЂ = Modality ­ЮЋёРѓЂ
        module MРѓѓ = Modality ­ЮЋёРѓѓ
        module MРѓЃ = Modality ­ЮЋёРѓЃ
    in
    (T MРѓЂ.­ЮЪўрхљ-allowed Рєњ T MРѓѓ.­ЮЪўрхљ-allowed) Рєњ
    (T MРѓЃ.­ЮЪўрхљ-allowed Ріј MРѓЃ.Trivial Рєњ T MРѓѓ.­ЮЪўрхљ-allowed Ріј MРѓѓ.Trivial) Рєњ
    (Рѕђ {mРѓѓ mРѓЃ} Рєњ mРѓѓ РЅ│рхљ mРѓЃ Рєњ PРѓЃ mРѓЃ Рєњ PРѓѓ mРѓѓ) Рєњ
    (Рѕђ {mРѓЂ mРѓѓ} Рєњ mРѓЂ РЅ│рхљ mРѓѓ Рєњ PРѓѓ mРѓѓ Рєњ PРѓЂ mРѓЂ) Рєњ
    mРѓЂ РЅ│рхљ mРѓЃ Рєњ PРѓЃ mРѓЃ Рєњ PРѓЂ mРѓЂ
  РЅ│рхљРєњРєљРѓѓ _ _ hypРѓЂ hypРѓѓ [ ­ЮЪЎрхљ ] =
    hypРѓѓ [ ­ЮЪЎрхљ ] РѕўРєњ hypРѓЂ [ ­ЮЪЎрхљ ]
  РЅ│рхљРєњРєљРѓѓ ­ЮЪўрхљРєњ­ЮЪўрхљ _ hypРѓЂ hypРѓѓ [ ­ЮЪўрхљ РдЃ okРѓЂ Рдё РдЃ okРѓѓ = okРѓЃ Рдё ] =
    case ­ЮЪўрхљРєњ­ЮЪўрхљ okРѓЂ of ╬╗
      okРѓѓ Рєњ
    hypРѓѓ [ ­ЮЪўрхљ РдЃ okРѓѓ = okРѓѓ Рдё ] РѕўРєњ hypРѓЂ [ ­ЮЪўрхљ РдЃ okРѓЂ = okРѓѓ Рдё ]
  РЅ│рхљРєњРєљРѓѓ
    {­ЮЋёРѓѓ} {mРѓЂ = ­ЮЪЎрхљ} {mРѓЃ = ­ЮЪўрхљ[ okРѓЃ ]}
    _ ­ЮЪўрхљРєљ­ЮЪўрхљ hypРѓЂ hypРѓѓ (­ЮЪЎрхљРЅ│­ЮЪўрхљ РдЃ okРѓѓ = okРѓЃ Рдё trivialРѓЂ) =
    case ­ЮЪўрхљРєљ­ЮЪўрхљ (injРѓЂ okРѓЃ) of ╬╗ where
      (injРѓЂ okРѓѓ) Рєњ
        hypРѓѓ (­ЮЪЎрхљРЅ│­ЮЪўрхљ РдЃ okРѓѓ = okРѓѓ Рдё trivialРѓЂ) РѕўРєњ
        hypРѓЂ [ ­ЮЪўрхљ РдЃ okРѓЂ = okРѓѓ Рдё ]
      (injРѓѓ trivialРѓѓ) Рєњ
        hypРѓѓ [ ­ЮЪЎрхљ ] РѕўРєњ hypРѓЂ (­ЮЪЎрхљРЅ│­ЮЪўрхљ trivialРѓѓ)

------------------------------------------------------------------------
-- The relation _РЅѕРЂ┐рхљ_

-- The natrec-modes from two possibly different modalities are
-- equivalent if they are the same (with arbitrary proofs).

infix 4 _РЅѕРЂ┐рхљ_

data _РЅѕРЂ┐рхљ_
       {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
       {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ} :
       Natrec-mode ­ЮЋёРѓЂ Рєњ Natrec-mode ­ЮЋёРѓѓ Рєњ Set (aРѓЂ Ріћ aРѓѓ) where
  Nr :
    РдЃ has-nrРѓЂ : Has-nr MРѓЂ (Modality.semiring-with-meet ­ЮЋёРѓЂ) Рдё Рєњ
    РдЃ has-nrРѓѓ : Has-nr MРѓѓ (Modality.semiring-with-meet ­ЮЋёРѓѓ) Рдё Рєњ
    Nr РЅѕРЂ┐рхљ Nr
  No-nr :
    No-nr РЅѕРЂ┐рхљ No-nr
  No-nr-glb :
    РдЃ okРѓЂ : Supports-GLB-for-natrec MРѓЂ (Modality.semiring-with-meet ­ЮЋёРѓЂ) Рдё Рєњ
    РдЃ okРѓѓ : Supports-GLB-for-natrec MРѓѓ (Modality.semiring-with-meet ­ЮЋёРѓѓ) Рдё Рєњ
    No-nr-glb РЅѕРЂ┐рхљ No-nr-glb

opaque

  -- The relation _РЅѕРЂ┐рхљ_ is reflexive.

  РЅѕРЂ┐рхљ-refl : nm РЅѕРЂ┐рхљ nm
  РЅѕРЂ┐рхљ-refl {nm = Nr} = Nr
  РЅѕРЂ┐рхљ-refl {nm = No-nr} = No-nr
  РЅѕРЂ┐рхљ-refl {nm = No-nr-glb} = No-nr-glb

opaque

  -- The relation _РЅѕРЂ┐рхљ_ is symmetric.

  РЅѕРЂ┐рхљ-sym : nmРѓЂ РЅѕРЂ┐рхљ nmРѓѓ Рєњ nmРѓѓ РЅѕРЂ┐рхљ nmРѓЂ
  РЅѕРЂ┐рхљ-sym Nr = Nr
  РЅѕРЂ┐рхљ-sym No-nr = No-nr
  РЅѕРЂ┐рхљ-sym No-nr-glb = No-nr-glb

opaque

  -- The relation _РЅѕРЂ┐рхљ_ is transitive.

  РЅѕРЂ┐рхљ-trans : nmРѓЂ РЅѕРЂ┐рхљ nmРѓѓ Рєњ nmРѓѓ РЅѕРЂ┐рхљ nmРѓЃ Рєњ nmРѓЂ РЅѕРЂ┐рхљ nmРѓЃ
  РЅѕРЂ┐рхљ-trans Nr Nr = Nr
  РЅѕРЂ┐рхљ-trans No-nr No-nr = No-nr
  РЅѕРЂ┐рхљ-trans No-nr-glb No-nr-glb = No-nr-glb

opaque

  -- The predicate Natrec-mode-has-nr is preserved by _РЅѕРЂ┐рхљ_

   Natrec-mode-has-nr-РЅѕРЂ┐рхљ :
     nmРѓЂ РЅѕРЂ┐рхљ nmРѓѓ Рєњ Natrec-mode-has-nr _ nmРѓЂ Рєњ Natrec-mode-has-nr _ nmРѓѓ
   Natrec-mode-has-nr-РЅѕРЂ┐рхљ Nr _ = Nr
   Natrec-mode-has-nr-РЅѕРЂ┐рхљ No-nr ()
   Natrec-mode-has-nr-РЅѕРЂ┐рхљ No-nr-glb ()

opaque

  -- The predicate Natrec-mode-no-nrРѓЂ is preserved by _РЅѕРЂ┐рхљ_

   Natrec-mode-no-nr-РЅѕРЂ┐рхљ :
     nmРѓЂ РЅѕРЂ┐рхљ nmРѓѓ Рєњ Natrec-mode-no-nr _ nmРѓЂ Рєњ Natrec-mode-no-nr _ nmРѓѓ
   Natrec-mode-no-nr-РЅѕРЂ┐рхљ No-nr _ = No-nr
   Natrec-mode-no-nr-РЅѕРЂ┐рхљ Nr ()
   Natrec-mode-no-nr-РЅѕРЂ┐рхљ No-nr-glb ()

opaque

  -- The predicate Natrec-mode-no-nrРѓѓ is preserved by _РЅѕРЂ┐рхљ_

   Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ :
     nmРѓЂ РЅѕРЂ┐рхљ nmРѓѓ Рєњ Natrec-mode-no-nr-glb _ nmРѓЂ Рєњ Natrec-mode-no-nr-glb _ nmРѓѓ
   Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ No-nr-glb _ = No-nr-glb
   Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ Nr ()
   Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ No-nr ()

------------------------------------------------------------------------
-- Common-properties

-- Properties common to Are-preserving-usage-restrictions and
-- Are-reflecting-usage-restrictions.

record Common-properties
  {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
  {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ}
  (RРѓЂ : Usage-restrictions ­ЮЋёРѓЂ) (RРѓѓ : Usage-restrictions ­ЮЋёРѓѓ) :
  Set (aРѓЂ Ріћ aРѓѓ) where
  no-eta-equality

  private
    module MРѓЂ = Modality ­ЮЋёРѓЂ
    module MРѓѓ = Modality ­ЮЋёРѓѓ
    module RРѓЂ = Usage-restrictions RРѓЂ
    module RРѓѓ = Usage-restrictions RРѓѓ

  field
    -- If ­ЮЪўрхљ is allowed for┬а­ЮЋёРѓЂ, then ­ЮЪўрхљ is allowed for┬а­ЮЋёРѓѓ.
    --
    -- Note that this property is also (at the time of writing) part
    -- of Is-morphism.
    ­ЮЪўрхљ-preserved : T MРѓЂ.­ЮЪўрхљ-allowed Рєњ T MРѓѓ.­ЮЪўрхљ-allowed

    -- The natrec-mode is preserved
    natrec-mode-preserved : RРѓЂ.natrec-mode РЅѕРЂ┐рхљ RРѓѓ.natrec-mode

    -- The property that strong unit types act as sinks is preserved.
    star╦б-sink-preserved : RРѓЂ.star╦б-sink РЅА RРѓѓ.star╦б-sink

    -- RРѓЂ.Id-erased holds if and only if RРѓѓ.Id-erased holds.
    Id-erased-preserved : RРѓЂ.Id-erased РЄћ RРѓѓ.Id-erased

    -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ, then RРѓЂ.erased-matches-for-J┬аmРѓЂ is bounded by
    -- RРѓѓ.erased-matches-for-J┬аmРѓѓ.
    erased-matches-for-J-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.erased-matches-for-J mРѓЂ РЅцрхЅрхљ RРѓѓ.erased-matches-for-J mРѓѓ

    -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ, then RРѓЂ.erased-matches-for-K┬аmРѓЂ is bounded by
    -- RРѓѓ.erased-matches-for-K┬аmРѓѓ.
    erased-matches-for-K-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.erased-matches-for-K mРѓЂ РЅцрхЅрхљ RРѓѓ.erased-matches-for-K mРѓѓ

  opaque

    -- If Nr-available holds in the source usage restrictions then it
    -- also holds in the target usage restrictions.

    nr-in-second-if-in-first :
      РдЃ has-nr : RРѓЂ.Nr-available Рдё Рєњ
      RРѓѓ.Nr-available
    nr-in-second-if-in-first РдЃ has-nr Рдё =
      Natrec-mode-has-nr-РЅѕРЂ┐рхљ natrec-mode-preserved has-nr

  opaque

    -- If Nr-not-available holds in the source usage restrictions then it
    -- also holds in the target usage restrictions.

    no-nr-in-second-if-in-first :
      РдЃ no-nr : RРѓЂ.Nr-not-available Рдё Рєњ
      RРѓѓ.Nr-not-available
    no-nr-in-second-if-in-first РдЃ no-nr Рдё =
      Natrec-mode-no-nr-РЅѕРЂ┐рхљ natrec-mode-preserved no-nr

  opaque

    -- If Nr-not-available-GLB holds in the source usage restrictions
    -- then it also holds in the target usage restrictions.

    no-nr-glb-in-second-if-in-first :
      РдЃ no-nr : RРѓЂ.Nr-not-available-GLB Рдё Рєњ
      RРѓѓ.Nr-not-available-GLB
    no-nr-glb-in-second-if-in-first РдЃ no-nr Рдё =
      Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ natrec-mode-preserved no-nr

  opaque

    -- If Nr-available holds in the target usage restrictions then it
    -- also holds in the source usage restrictions.

    nr-in-first-if-in-second :
      РдЃ has-nr : RРѓѓ.Nr-available Рдё Рєњ
      RРѓЂ.Nr-available
    nr-in-first-if-in-second РдЃ has-nr Рдё =
      Natrec-mode-has-nr-РЅѕРЂ┐рхљ (РЅѕРЂ┐рхљ-sym natrec-mode-preserved) has-nr

  opaque

    -- If Nr-not-available holds in the target usage restrictions then it
    -- also holds in the source usage restrictions.

    no-nr-in-first-if-in-second :
      РдЃ no-nr : RРѓѓ.Nr-not-available Рдё Рєњ
      RРѓЂ.Nr-not-available
    no-nr-in-first-if-in-second РдЃ no-nr Рдё =
      Natrec-mode-no-nr-РЅѕРЂ┐рхљ (РЅѕРЂ┐рхљ-sym natrec-mode-preserved) no-nr

  opaque

    -- If Nr-not-available-GLB holds in the target usage restrictions
    -- then it also holds in the source usage restrictions.

    no-nr-glb-in-first-if-in-second :
      РдЃ no-nr : RРѓѓ.Nr-not-available-GLB Рдё Рєњ
      RРѓЂ.Nr-not-available-GLB
    no-nr-glb-in-first-if-in-second РдЃ no-nr Рдё =
      Natrec-mode-no-nr-glb-РЅѕРЂ┐рхљ (РЅѕРЂ┐рхљ-sym natrec-mode-preserved) no-nr

opaque

  -- The relation Common-properties is reflexive.

  Common-properties-reflexive : Common-properties R R
  Common-properties-reflexive = ╬╗ where
      .­ЮЪўрхљ-preserved                   Рєњ idрХа
      .natrec-mode-preserved          Рєњ РЅѕРЂ┐рхљ-refl
      .star╦б-sink-preserved           Рєњ refl
      .Id-erased-preserved            Рєњ idРЄћ
      .erased-matches-for-J-preserved Рєњ РЅѕрхљРєњРЅцрхЅрхљРѓЂ
      .erased-matches-for-K-preserved Рєњ РЅѕрхљРєњРЅцрхЅрхљРѓЂ
    where
    open Common-properties

opaque

  -- The relation Common-properties is transitive.

  Common-properties-transitive :
    Common-properties RРѓЂ RРѓѓ Рєњ Common-properties RРѓѓ RРѓЃ Рєњ
    Common-properties RРѓЂ RРѓЃ
  Common-properties-transitive cpРѓЂ cpРѓѓ = ╬╗ where
      .­ЮЪўрхљ-preserved Рєњ
        CPРѓѓ.­ЮЪўрхљ-preserved РѕўРєњ CPРѓЂ.­ЮЪўрхљ-preserved
      .natrec-mode-preserved Рєњ
        РЅѕРЂ┐рхљ-trans CPРѓЂ.natrec-mode-preserved CPРѓѓ.natrec-mode-preserved
      .star╦б-sink-preserved Рєњ
        trans CPРѓЂ.star╦б-sink-preserved CPРѓѓ.star╦б-sink-preserved
      .Id-erased-preserved Рєњ
        CPРѓѓ.Id-erased-preserved РѕўРЄћ CPРѓЂ.Id-erased-preserved
      .erased-matches-for-J-preserved Рєњ
        РЅѕрхљРєњРЅцрхЅрхљРѓѓ CPРѓЂ.­ЮЪўрхљ-preserved CPРѓЂ.erased-matches-for-J-preserved
          CPРѓѓ.erased-matches-for-J-preserved
      .erased-matches-for-K-preserved Рєњ
        РЅѕрхљРєњРЅцрхЅрхљРѓѓ CPРѓЂ.­ЮЪўрхљ-preserved CPРѓЂ.erased-matches-for-K-preserved
          CPРѓѓ.erased-matches-for-K-preserved
    where
    open Common-properties
    module CPРѓЂ = Common-properties cpРѓЂ
    module CPРѓѓ = Common-properties cpРѓѓ

------------------------------------------------------------------------
-- Are-preserving-usage-restrictions

-- The property of preserving Usage-restrictions.

record Are-preserving-usage-restrictions
         {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
         {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ}
         (RРѓЂ : Usage-restrictions ­ЮЋёРѓЂ) (RРѓѓ : Usage-restrictions ­ЮЋёРѓѓ)
         (tr tr-╬Б : MРѓЂ Рєњ MРѓѓ) : Set (aРѓЂ Ріћ aРѓѓ) where
  no-eta-equality

  private
    module RРѓЂ = Usage-restrictions RРѓЂ
    module RРѓѓ = Usage-restrictions RРѓѓ

  open RI RРѓЂ
  open RI RРѓѓ

  field
    -- Common properties.
    common-properties : Common-properties RРѓЂ RРѓѓ

  open Common-properties common-properties

  field

    -- The function tr is assumed to satisfy some properties depending
    -- on the chosen Natrec-mode. Note that by common-properties, both
    -- the source and target usage restrictions have the same
    -- Natrec-mode.

    nr-preserving :
      РдЃ has-nrРѓЂ : RРѓЂ.Nr-available Рдё Рєњ
      РдЃ has-nrРѓѓ : RРѓѓ.Nr-available Рдё Рєњ
      Is-nr-preserving-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    no-nr-preserving :
      РдЃ no-nrРѓЂ : RРѓЂ.Nr-not-available Рдё Рєњ
      РдЃ no-nrРѓѓ : RРѓѓ.Nr-not-available Рдё Рєњ
      Is-no-nr-preserving-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    no-nr-glb-preserving :
      РдЃ no-nrРѓЂ : RРѓЂ.Nr-not-available-GLB Рдё Рєњ
      РдЃ no-nrРѓѓ : RРѓѓ.Nr-not-available-GLB Рдё Рєњ
      Is-no-nr-glb-preserving-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    -- The functions tr and tr-╬Б preserve the Prodrec-allowed
    -- property in a certain way.
    Prodrec-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.Prodrec-allowed mРѓЂ r p q Рєњ
      RРѓѓ.Prodrec-allowed mРѓѓ (tr r) (tr-╬Б p) (tr q)

    -- The function tr preserves the Unitrec-allowed property in a
    -- certain way.
    Unitrec-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.Unitrec-allowed mРѓЂ p q Рєњ
      RРѓѓ.Unitrec-allowed mРѓѓ (tr p) (tr q)

    -- The function tr preserves the Emptyrec-allowed property in a
    -- certain way.
    Emptyrec-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.Emptyrec-allowed mРѓЂ p Рєњ
      RРѓѓ.Emptyrec-allowed mРѓѓ (tr p)

    -- The []-cong-allowed-mode property respects equivalent modes
    []-cong-preserved :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓЂ.[]-cong-allowed-mode s mРѓЂ Рєњ
      RРѓѓ.[]-cong-allowed-mode s mРѓѓ

  open Common-properties common-properties public

opaque

  -- For every value R the identity function preserves
  -- Usage-restrictions for R and┬аR.

  Are-preserving-usage-restrictions-id :
    Are-preserving-usage-restrictions R R idрХа idрХа
  Are-preserving-usage-restrictions-id {R} = ╬╗ where
      .common-properties  Рєњ Common-properties-reflexive
      .nr-preserving РдЃ has-nrРѓЂ Рдё РдЃ has-nrРѓѓ Рдё Рєњ
        case Nr-available-propositional _ has-nrРѓЂ has-nrРѓѓ of ╬╗ where
          refl Рєњ Is-nr-preserving-morphism-id
      .no-nr-preserving      Рєњ Is-no-nr-preserving-morphism-id
      .no-nr-glb-preserving  Рєњ Is-no-nr-glb-preserving-morphism-id
      .Prodrec-preserved     Рєњ РЅѕрхљРєњРєњРѓЂ
      .Unitrec-preserved     Рєњ РЅѕрхљРєњРєњРѓЂ
      .Emptyrec-preserved    Рєњ РЅѕрхљРєњРєњРѓЂ
      .[]-cong-preserved     Рєњ РЅѕрхљРєњРєњРѓЂ
    where
    open Are-preserving-usage-restrictions
    open Usage-restrictions R
    open RI R

opaque

  -- Composition preserves Are-preserving-usage-restrictions (in a
  -- certain sense).

  Are-preserving-usage-restrictions-Рѕў :
    {RРѓЂ : Usage-restrictions ­ЮЋёРѓЂ} Рєњ
    {RРѓѓ : Usage-restrictions ­ЮЋёРѓѓ} Рєњ
    {RРѓЃ : Usage-restrictions ­ЮЋёРѓЃ} Рєњ
    Is-morphism ­ЮЋёРѓѓ ­ЮЋёРѓЃ trРѓЂ Рєњ
    Is-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ trРѓѓ Рєњ
    Are-preserving-usage-restrictions RРѓѓ RРѓЃ trРѓЂ tr-╬БРѓЂ Рєњ
    Are-preserving-usage-restrictions RРѓЂ RРѓѓ trРѓѓ tr-╬БРѓѓ Рєњ
    Are-preserving-usage-restrictions
      RРѓЂ RРѓЃ (trРѓЂ РѕўРєњ trРѓѓ) (tr-╬БРѓЂ РѕўРєњ tr-╬БРѓѓ)
  Are-preserving-usage-restrictions-Рѕў {RРѓЂ} {RРѓѓ} {RРѓЃ} mРѓЂ mРѓѓ uРѓЂ uРѓѓ = ╬╗ where
      .common-properties Рєњ
        Common-properties-transitive PРѓѓ.common-properties
          PРѓЂ.common-properties
      .nr-preserving Рєњ
        let has-nr = PРѓѓ.nr-in-second-if-in-first
        in  Is-nr-preserving-morphism-Рѕў
              РдЃ has-nrРѓѓ = RI.Nr-available-Has-nr RРѓѓ РдЃ has-nr Рдё Рдё
              mРѓЂ (PРѓЂ.nr-preserving РдЃ has-nr Рдё)
              (PРѓѓ.nr-preserving РдЃ has-nrРѓѓ = has-nr Рдё)
      .no-nr-preserving Рєњ
        let no-nr = PРѓѓ.no-nr-in-second-if-in-first
        in  Is-no-nr-preserving-morphism-Рѕў
              mРѓѓ (PРѓЂ.no-nr-preserving РдЃ no-nr Рдё )
              (PРѓѓ.no-nr-preserving РдЃ no-nrРѓѓ = no-nr Рдё)
      .no-nr-glb-preserving Рєњ
        let no-nr = PРѓѓ.no-nr-glb-in-second-if-in-first
        in  Is-no-nr-glb-preserving-morphism-Рѕў
              (PРѓЂ.no-nr-glb-preserving РдЃ no-nr Рдё)
              (PРѓѓ.no-nr-glb-preserving РдЃ no-nrРѓѓ = no-nr Рдё)
      .Prodrec-preserved Рєњ
        РЅѕрхљРєњРєњРѓѓ PРѓѓ.­ЮЪўрхљ-preserved PРѓѓ.Prodrec-preserved PРѓЂ.Prodrec-preserved
      .Unitrec-preserved Рєњ
        РЅѕрхљРєњРєњРѓѓ PРѓѓ.­ЮЪўрхљ-preserved PРѓѓ.Unitrec-preserved PРѓЂ.Unitrec-preserved
      .Emptyrec-preserved Рєњ
        РЅѕрхљРєњРєњРѓѓ PРѓѓ.­ЮЪўрхљ-preserved PРѓѓ.Emptyrec-preserved
          PРѓЂ.Emptyrec-preserved
      .[]-cong-preserved Рєњ
        РЅѕрхљРєњРєњРѓѓ PРѓѓ.­ЮЪўрхљ-preserved PРѓѓ.[]-cong-preserved
          PРѓЂ.[]-cong-preserved
    where
    open Are-preserving-usage-restrictions
    open RI RРѓЂ
    open RI RРѓѓ
    open RI RРѓЃ
    module PРѓЂ = Are-preserving-usage-restrictions uРѓЂ
    module PРѓѓ = Are-preserving-usage-restrictions uРѓѓ
    open PРѓЂ

------------------------------------------------------------------------
-- Are-reflecting-usage-restrictions

-- The property of reflecting Usage-restrictions.

record Are-reflecting-usage-restrictions
         {MРѓЂ : Set aРѓЂ} {MРѓѓ : Set aРѓѓ}
         {­ЮЋёРѓЂ : Modality MРѓЂ} {­ЮЋёРѓѓ : Modality MРѓѓ}
         (RРѓЂ : Usage-restrictions ­ЮЋёРѓЂ) (RРѓѓ : Usage-restrictions ­ЮЋёРѓѓ)
         (tr tr-╬Б : MРѓЂ Рєњ MРѓѓ) : Set (aРѓЂ Ріћ aРѓѓ) where
  no-eta-equality

  private
    module MРѓЂ = Modality ­ЮЋёРѓЂ
    module MРѓѓ = Modality ­ЮЋёРѓѓ
    module RРѓЂ = Usage-restrictions RРѓЂ
    module RРѓѓ = Usage-restrictions RРѓѓ

  open RI RРѓЂ
  open RI RРѓѓ

  field
    -- Common properties.
    common-properties : Common-properties RРѓЂ RРѓѓ

    -- If ­ЮЪўрхљ is allowed for ­ЮЋёРѓѓ or ­ЮЋёРѓѓ is trivial, then ­ЮЪўрхљ is allowed
    -- for ­ЮЋёРѓЂ or ­ЮЋёРѓЂ is trivial.
    ­ЮЪўрхљ-reflected :
      T MРѓѓ.­ЮЪўрхљ-allowed Ріј MРѓѓ.Trivial Рєњ T MРѓЂ.­ЮЪўрхљ-allowed Ріј MРѓЂ.Trivial

    -- The function tr is assumed to satisfy some properties depending
    -- on the chosen Natrec-mode. Note that by common-properties, both
    -- the source and target usage restrictions have the same
    -- Natrec-mode.

    nr-reflected :
      РдЃ has-nrРѓЂ : RРѓЂ.Nr-available Рдё Рєњ
      РдЃ has-nrРѓѓ : RРѓѓ.Nr-available Рдё Рєњ
      Is-nr-reflecting-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    no-nr-reflected :
      РдЃ no-nrРѓЂ : RРѓЂ.Nr-not-available Рдё Рєњ
      РдЃ no-nrРѓѓ : RРѓѓ.Nr-not-available Рдё Рєњ
      Is-no-nr-reflecting-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    no-nr-glb-reflected :
      РдЃ no-nrРѓЂ : RРѓЂ.Nr-not-available-GLB Рдё Рєњ
      РдЃ no-nrРѓѓ : RРѓѓ.Nr-not-available-GLB Рдё Рєњ
      Is-no-nr-glb-reflecting-morphism ­ЮЋёРѓЂ ­ЮЋёРѓѓ tr

    -- The functions tr and tr-╬Б reflect the Prodrec-allowed property
    -- in a certain way.
    Prodrec-reflected :
      mРѓЂ РЅ│рхљ mРѓѓ Рєњ
      RРѓѓ.Prodrec-allowed mРѓѓ (tr r) (tr-╬Б p) (tr q) Рєњ
      RРѓЂ.Prodrec-allowed mРѓЂ r p q

    -- The function tr reflects the Unitrec-allowed property in a
    -- certain way.
    Unitrec-reflected :
      mРѓЂ РЅ│рхљ mРѓѓ Рєњ
      RРѓѓ.Unitrec-allowed mРѓѓ (tr p) (tr q) Рєњ
      RРѓЂ.Unitrec-allowed mРѓЂ p q

    -- The function tr reflects the Emptyrec-allowed property in a
    -- certain way.
    Emptyrec-reflected :
      mРѓЂ РЅ│рхљ mРѓѓ Рєњ
      RРѓѓ.Emptyrec-allowed mРѓѓ (tr p) Рєњ
      RРѓЂ.Emptyrec-allowed mРѓЂ p

    -- The []-cong-allowed-mode property is reflected in a certain way.
    []-cong-reflected :
      mРѓЂ РЅ│рхљ mРѓѓ Рєњ
      RРѓѓ.[]-cong-allowed-mode s mРѓѓ Рєњ
      RРѓЂ.[]-cong-allowed-mode s mРѓЂ


    -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ holds, then RРѓѓ.Erased-matches-for-J┬аmРѓѓ is bounded
    -- by RРѓЂ.erased-matches-for-J┬аmРѓЂ.
    erased-matches-for-J-reflected :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓѓ.erased-matches-for-J mРѓѓ РЅцрхЅрхљ RРѓЂ.erased-matches-for-J mРѓЂ

    -- If mРѓЂ┬аРЅѕрхљ┬аmРѓѓ holds, then RРѓѓ.Erased-matches-for-K┬аmРѓѓ is bounded
    -- by RРѓЂ.erased-matches-for-K┬аmРѓЂ.
    erased-matches-for-K-reflected :
      mРѓЂ РЅѕрхљ mРѓѓ Рєњ
      RРѓѓ.erased-matches-for-K mРѓѓ РЅцрхЅрхљ RРѓЂ.erased-matches-for-K mРѓЂ

  open Common-properties common-properties public

opaque

  -- For every value R the identity function reflects
  -- Usage-restrictions for R and┬аR.

  Are-reflecting-usage-restrictions-id :
    Are-reflecting-usage-restrictions R R idрХа idрХа
  Are-reflecting-usage-restrictions-id {R} = ╬╗ where
      .common-properties              Рєњ Common-properties-reflexive
      .­ЮЪўрхљ-reflected                   Рєњ idрХа
      .nr-reflected РдЃ has-nrРѓЂ Рдё РдЃ has-nrРѓѓ Рдё Рєњ
        case Nr-available-propositional _ has-nrРѓЂ has-nrРѓѓ of ╬╗ where
          refl Рєњ Is-nr-reflecting-morphism-id
      .no-nr-reflected                Рєњ Is-no-nr-reflecting-morphism-id
      .no-nr-glb-reflected            Рєњ Is-no-nr-glb-reflecting-morphism-id
      .Prodrec-reflected              Рєњ РЅ│рхљРєњРєљРѓЂ
      .Unitrec-reflected              Рєњ РЅ│рхљРєњРєљРѓЂ
      .Emptyrec-reflected             Рєњ РЅ│рхљРєњРєљРѓЂ
      .[]-cong-reflected              Рєњ РЅ│рхљРєњРєљРѓЂ
      .erased-matches-for-J-reflected Рєњ РЅѕрхљРєњРЅцрхЅрхљРѓЂ РѕўРєњ РЅѕрхљ-symmetric
      .erased-matches-for-K-reflected Рєњ РЅѕрхљРєњРЅцрхЅрхљРѓЂ РѕўРєњ РЅѕрхљ-symmetric
    where
    open Are-reflecting-usage-restrictions
    open RI R
    open Usage-restrictions R

opaque

  -- Composition preserves Are-reflecting-usage-restrictions (in a
  -- certain sense).

  Are-reflecting-usage-restrictions-Рѕў :
    {RРѓЂ : Usage-restrictions ­ЮЋёРѓЂ} Рєњ
    {RРѓѓ : Usage-restrictions ­ЮЋёРѓѓ} Рєњ
    {RРѓЃ : Usage-restrictions ­ЮЋёРѓЃ} Рєњ
    Is-morphism ­ЮЋёРѓѓ ­ЮЋёРѓЃ trРѓЂ Рєњ
    Are-reflecting-usage-restrictions RРѓѓ RРѓЃ trРѓЂ tr-╬БРѓЂ Рєњ
    Are-reflecting-usage-restrictions RРѓЂ RРѓѓ trРѓѓ tr-╬БРѓѓ Рєњ
    Are-reflecting-usage-restrictions
      RРѓЂ RРѓЃ (trРѓЂ РѕўРєњ trРѓѓ) (tr-╬БРѓЂ РѕўРєњ tr-╬БРѓѓ)
  Are-reflecting-usage-restrictions-Рѕў {RРѓЂ} {RРѓѓ} {RРѓЃ} m mРѓЂ mРѓѓ = ╬╗ where
      .common-properties Рєњ
        Common-properties-transitive RРѓѓ.common-properties
          RРѓЂ.common-properties
      .­ЮЪўрхљ-reflected Рєњ
        RРѓѓ.­ЮЪўрхљ-reflected РѕўРєњ RРѓЂ.­ЮЪўрхљ-reflected
      .nr-reflected Рєњ
        let has-nr = RРѓѓ.nr-in-second-if-in-first
        in  Is-nr-reflecting-morphism-Рѕў
              РдЃ has-nrРѓѓ = RI.Nr-available-Has-nr RРѓѓ РдЃ has-nr Рдё Рдё
              m (RРѓЂ.nr-reflected РдЃ has-nr Рдё)
              (RРѓѓ.nr-reflected РдЃ has-nrРѓѓ = has-nr Рдё)
      .no-nr-reflected Рєњ
        let no-nr = RРѓѓ.no-nr-in-second-if-in-first
        in  Is-no-nr-reflecting-morphism-Рѕў
              m (RРѓЂ.no-nr-reflected РдЃ no-nr Рдё)
              (RРѓѓ.no-nr-reflected РдЃ no-nrРѓѓ = no-nr Рдё)
      .no-nr-glb-reflected Рєњ
        let no-nr = RРѓѓ.no-nr-glb-in-second-if-in-first
        in  Is-no-nr-glb-reflecting-morphism-Рѕў
              m (RРѓЂ.no-nr-glb-reflected РдЃ no-nr Рдё)
              (RРѓѓ.no-nr-glb-reflected РдЃ no-nrРѓѓ = no-nr Рдё)
      .Prodrec-reflected Рєњ
        РЅ│рхљРєњРєљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.­ЮЪўрхљ-reflected RРѓЂ.Prodrec-reflected
          RРѓѓ.Prodrec-reflected
      .Unitrec-reflected Рєњ
        РЅ│рхљРєњРєљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.­ЮЪўрхљ-reflected RРѓЂ.Unitrec-reflected
          RРѓѓ.Unitrec-reflected
      .Emptyrec-reflected Рєњ
        РЅ│рхљРєњРєљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.­ЮЪўрхљ-reflected RРѓЂ.Emptyrec-reflected
          RРѓѓ.Emptyrec-reflected
      .[]-cong-reflected Рєњ
        РЅ│рхљРєњРєљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.­ЮЪўрхљ-reflected RРѓЂ.[]-cong-reflected
          RРѓѓ.[]-cong-reflected
      .erased-matches-for-J-reflected Рєњ
        РЅѕрхљРєњРЅЦрхЅрхљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.erased-matches-for-J-reflected
          RРѓѓ.erased-matches-for-J-reflected
      .erased-matches-for-K-reflected Рєњ
        РЅѕрхљРєњРЅЦрхЅрхљРѓѓ RРѓѓ.­ЮЪўрхљ-preserved RРѓЂ.erased-matches-for-K-reflected
          RРѓѓ.erased-matches-for-K-reflected
    where
    open Are-reflecting-usage-restrictions
    module RРѓЂ = Are-reflecting-usage-restrictions mРѓЂ
    module RРѓѓ = Are-reflecting-usage-restrictions mРѓѓ
    open RI RРѓЂ
    open RI RРѓѓ
    open RI RРѓЃ
