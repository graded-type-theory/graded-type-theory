------------------------------------------------------------------------
-- Properties of the usage relation for Heaps, Stacks and States
-- and the reduction relation with resource tracking.
------------------------------------------------------------------------

open import Graded.Modality
open import Graded.Usage.Restrictions
open import Heap.Usage.Assumptions
open import Heap.Options
open import Definition.Typed.Variant

module Heap.Usage.Reduction
  {a} {M : Set a} {ğ•„ : Modality M}
  {UR : Usage-restrictions ğ•„}
  {type-variant : Type-variant}
  (UA : UsageAssumptions type-variant UR)
  (opts : Options)
  (open Options opts)
  â¦ƒ _ : Track-resources â¦„
  where

open UsageAssumptions UA
open Modality ğ•„

open import Tools.Empty
open import Tools.Function
open import Tools.Product
open import Tools.PropositionalEquality
open import Tools.Unit
import Tools.Reasoning.PartialOrder as RPo

open import Definition.Untyped M

open import Heap.Untyped ğ•„ type-variant
open import Heap.Untyped.Properties ğ•„ type-variant
open import Heap.Reduction ğ•„ type-variant opts
open import Heap.Usage ğ•„ type-variant UR
open import Heap.Usage.Properties type-variant UR
open import Heap.Usage.Weakening type-variant UR

open import Graded.Context ğ•„
open import Graded.Context.Properties ğ•„
open import Graded.Context.Weakening ğ•„
open import Graded.Modality.Dedicated-nr ğ•„
open import Graded.Modality.Nr-instances
open import Graded.Modality.Properties ğ•„
open import Graded.Mode ğ•„
open import Graded.Usage ğ•„ UR
open import Graded.Usage.Erased-matches
open import Graded.Usage.Inversion ğ•„ UR
open import Graded.Usage.Properties ğ•„ UR
open import Graded.Usage.Weakening ğ•„ UR

private variable
  Î³ Î´ Î· : Conâ‚˜ _
  s sâ€² : State _ _ _

opaque

  â–¸-â‡’áµ¥ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸ s) (d : s â‡’áµ¥ sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸ sâ€²)
  â–¸-â‡’áµ¥ {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (lamâ‚• {p} {E} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (âˆ˜â‚‘ {Î³ = Î³â€²} â–¸u) â–¸S) â†’
    case inv-usage-lam â–¸t of Î»
      (invUsageLam {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
    _ , _ , _
      , subâ‚• â–¸H (â‰¤á¶œ-trans Î³â‰¤
          (â‰¤á¶œ-reflexive (â‰ˆá¶œ-trans (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)))
            (â‰ˆá¶œ-sym (â‰ˆá¶œ-trans (+á¶œ-congË¡ (Â·á¶œ-assoc _ _ _))
              (+á¶œ-assoc _ _ _))))))
      âˆ™ â–¸á¶œáµ– (â–¸-cong (sym (â‰¢ğŸ˜â†’âŒÂ·âŒŸâ‰¡ (â–¸âˆ£Sâˆ£â‰¢ğŸ˜ â–¸S))) â–¸u)
      , â–¸t , wk-â–¸Ë¢ (step id) â–¸S
      , (begin
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î· âˆ™ âˆ£ S âˆ£ Â· p                    â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âˆ™ â‰¤-refl âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· âˆ™ âˆ£ S âˆ£ Â· p                   â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (wk-âˆ£Sâˆ£ (step id) S)) âˆ™ Â·-congÊ³ (wk-âˆ£Sâˆ£ (step id) S) âŸ©
          âˆ£ wk1Ë¢ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· âˆ™ âˆ£ wk1Ë¢ S âˆ£ Â· p          â‰ˆË˜âŸ¨ â‰ˆá¶œ-refl âˆ™ Â·-congË¡ (Â·-identityË¡ p) âŸ©
          âˆ£ wk1Ë¢ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· âˆ™ âˆ£ wk1Ë¢ S âˆ£ Â· ğŸ™ Â· p      â‰ˆË˜âŸ¨ â‰ˆá¶œ-refl âˆ™ +-identityÊ³ _ âŸ©
          âˆ£ wk1Ë¢ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· âˆ™ âˆ£ wk1Ë¢ S âˆ£ Â· ğŸ™ Â· p + ğŸ˜  âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (prodË¢â‚•â‚ {p} {E} {S}) =
    case inv-usage-prodË¢ â–¸t of Î»
      (invUsageProdË¢ {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u Î´â‰¤) â†’
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (fstâ‚‘ pâ‰¤ğŸ™) â–¸S) â†’
    _ , _ , _
      , â–¸H , â–¸-cong (â‰¢ğŸ˜â†’áµÂ·â‰¡ (Î» { refl â†’ ğŸ˜â‰°ğŸ™ pâ‰¤ğŸ™})) â–¸t , â–¸S
      , (begin
          Î³ â‰¤âŸ¨ Î³â‰¤ âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ  â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ                 â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-identityÊ³ _) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E (p Â·á¶œ Î´â‚ âˆ§á¶œ Î´â‚‚) +á¶œ Î·         â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (âˆ§á¶œ-decreasingË¡ (p Â·á¶œ Î´â‚) Î´â‚‚))) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E (p Â·á¶œ Î´â‚) +á¶œ Î·               â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³(wk-â‰¤á¶œ E (Â·á¶œ-monotoneË¡ pâ‰¤ğŸ™))) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E (ğŸ™ Â·á¶œ Î´â‚) +á¶œ Î·               â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E (Â·á¶œ-identityË¡ Î´â‚))) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â‚ +á¶œ Î·                      âˆ) }
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (prodË¢â‚•â‚‚ {p} {E} {S}) =
    case inv-usage-prodË¢ â–¸t of Î»
      (invUsageProdË¢ {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u Î´â‰¤) â†’
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} sndâ‚‘ â–¸S) â†’
    _ , _ , _ , â–¸H , â–¸u , â–¸S
      , (begin
          Î³ â‰¤âŸ¨ Î³â‰¤ âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ  â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ           â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E (p Â·á¶œ Î´â‚ âˆ§á¶œ Î´â‚‚) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (âˆ§á¶œ-decreasingÊ³ (p Â·á¶œ Î´â‚) Î´â‚‚))) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â‚‚ +á¶œ Î·                       âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (prodÊ·â‚• {p} {tâ‚} {E} {r} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (prodrecâ‚‘ {Î³ = Î³â€²} â–¸u râ‰¢ğŸ˜) â–¸S) â†’
    case inv-usage-prodÊ· â–¸t of Î»
      (invUsageProdÊ· {Î´ = Î´â€²} {Î· = Î·â€²} â–¸tâ‚ â–¸tâ‚‚ Î´â‰¤) â†’
    case (begin
          Î³                                                                                                      â‰¤âŸ¨ Î³â‰¤ âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                                                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E (p Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                                         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ (wká¶œ E (p Â·á¶œ Î´â€²) +á¶œ wká¶œ E Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                                 â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (wk-Â·á¶œ E))) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ (p Â·á¶œ wká¶œ E Î´â€² +á¶œ wká¶œ E Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                                   â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ (âˆ£ S âˆ£ Â· r) _ _) âŸ©
          ((âˆ£ S âˆ£ Â· r) Â·á¶œ p Â·á¶œ wká¶œ E Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                    â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (Â·á¶œ-assoc (âˆ£ S âˆ£ Â· r) p _)) âŸ©
          (((âˆ£ S âˆ£ Â· r) Â· p) Â·á¶œ wká¶œ E Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                   â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-assoc âˆ£ S âˆ£ r p))) âŸ©
          ((âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ E Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                     â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
          (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ E Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²                     â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-comm _ _) âŸ©
          (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€² +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ E Î´â€²                     â‰ˆË˜âŸ¨ +á¶œ-assoc _ _ _ âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ E Î´â€²                   â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-congÊ³ (+-identityÊ³ _)) âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p + ğŸ˜) Â·á¶œ wká¶œ E Î´â€²               â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-congÊ³ (+-congË¡ (Â·-zeroÊ³ _))) âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p + (âˆ£ S âˆ£ Â· r) Â· ğŸ˜) Â·á¶œ wká¶œ E Î´â€² âˆ) of Î»
      Î³â‰¤â€² â†’
    case substâ‚‚ (Î» x y â†’ Î´â€² â¨¾ x â–¸á¶œ[ âŒ p âŒŸ ] (y , tâ‚ , E))
           (trans lemma (sym (trans (+-congË¡ (Â·-zeroÊ³ _)) (+-identityÊ³ _))))
           lemma
           (â–¸á¶œ â–¸tâ‚ â‰¤-refl) of Î»
      â–¸á¶œtâ‚ â†’
    _ , _ , _
      , subâ‚• â–¸H Î³â‰¤â€² âˆ™ â–¸á¶œtâ‚ âˆ™ â–¸á¶œÂ¹ â–¸tâ‚‚ â‰¤-refl
      , â–¸u , wk-â–¸Ë¢ (step (step id)) â–¸S
      , â‰¤á¶œ-reflexive (â‰ˆá¶œ-trans (+á¶œ-comm Î· _) (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S)))
          âˆ™ trans (Â·-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S)) (sym (+-identityÊ³ _))
          âˆ™ trans (Â·-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S)) (sym (+-identityÊ³ _ ))) }
      where
      open RPo â‰¤á¶œ-poset
      lemmaâ€² : âˆ€ m â†’ âŒ p âŒŸ â‰¡ m â†’ âŒœ m âŒ Â· (âˆ£ S âˆ£ Â· r Â· p) â‰¡ âˆ£ S âˆ£ Â· r Â· p
      lemmaâ€² ğŸ˜áµ pâ‰¡m rewrite âŒâŒŸâ‰¡ğŸ˜áµâ†’â‰¡ğŸ˜ pâ‰¡m =
        trans (Â·-zeroË¡ _) (trans (sym (Â·-zeroÊ³ _)) (Â·-assoc _ _ _))
      lemmaâ€² ğŸ™áµ _ = Â·-identityË¡ _
      lemma : âŒœ âŒ p âŒŸ âŒ Â· (âˆ£ S âˆ£ Â· r Â· p) â‰¡ âˆ£ S âˆ£ Â· r Â· p
      lemma = lemmaâ€² âŒ p âŒŸ refl
  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (zeroâ‚• {E} {p} {r} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (natrecâ‚‘ {Î³ = Î³â€²} {Î´ = Î´â€²} â–¸z â–¸s â–¸A) â–¸S) â†’
    _ , _ , _ , â–¸H , â–¸z , â–¸S , (begin
      Î³                                                                       â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (inv-usage-zero â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ E ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ E) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                            â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                                  â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Eâ€² (nrá¶œ-zero â‰¤á¶œ-refl))) âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€²                                                  â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î³â€² +á¶œ Î·                                                  âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (sucâ‚• {E} {p} {r} {s} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (natrecâ‚‘ {Î³ = Î³â€²} {Î´ = Î´â€²} â–¸z â–¸s â–¸A) â–¸S) â†’
    case substâ‚‚ (Î» x y â†’ _ âˆ™ x âˆ™ y â–¸ s) (sym (Â·-identityË¡ p)) (sym (Â·-identityË¡ r)) â–¸s of Î»
      â–¸sâ€² â†’
    case inv-usage-suc â–¸t of Î»
      (invUsageSuc {Î´ = Î¸} â–¸t Î´â‰¤Î¸) â†’
    case wk-âˆ£Sâˆ£ (step (step id)) S of Î»
      âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£ â†’
    case natrecâ‚˜
           (wkUsage (step id) â–¸z)
           (wkUsage (liftn (step id) 2) â–¸sâ€²)
           var
           (wkUsage (lift (step id)) â–¸A) of Î»
      â–¸nr â†’
    let lemmaâ‚ƒ : âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)
        lemmaâ‚ƒ = begin
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                             â‰¤âŸ¨ Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Eâ€² nrá¶œ-suc) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (Î´â€² +á¶œ p Â·á¶œ ğŸ˜á¶œ +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)      â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Eâ€² (+á¶œ-congË¡ (+á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ p)))) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (Î´â€² +á¶œ ğŸ˜á¶œ +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)           â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Eâ€² (+á¶œ-congË¡ (+á¶œ-identityË¡ _))) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (Î´â€² +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                 â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-+á¶œ Eâ€²) âŸ©
           âˆ£ S âˆ£ Â·á¶œ (wká¶œ Eâ€² Î´â€² +á¶œ wká¶œ Eâ€² (r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ))        â‰ˆâŸ¨ Â·á¶œ-distribË¡-+á¶œ _ _ _ âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰ˆâŸ¨ +á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-Â·á¶œ Eâ€²)) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ r Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)  â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-assoc _ _ _) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) âˆ
        lemmaâ‚„ : Î³ â‰¤á¶œ ((âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ Î·) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™) Â·á¶œ wká¶œ E Î¸
        lemmaâ‚„ = begin
           Î³
             â‰¤âŸ¨ Î³â‰¤ âŸ©
           (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)
             â‰¤âŸ¨ +á¶œ-monotone (Â·á¶œ-monotone (wk-â‰¤á¶œ E Î´â‰¤Î¸) (lemmaâ‚‚ âˆ£ S âˆ£ p r)) (+á¶œ-monotoneÊ³ lemmaâ‚ƒ) âŸ©
           (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™) Â·á¶œ wká¶œ E Î¸ +á¶œ Î· +á¶œ (âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ))
             â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
           (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™) Â·á¶œ wká¶œ E Î¸
             â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-assoc _ _ _) âŸ©
           ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™) Â·á¶œ wká¶œ E Î¸
             â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (+á¶œ-comm _ _)) âŸ©
           ((âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ Î·) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Eâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™) Â·á¶œ wká¶œ E Î¸ âˆ
    in  _ , _ , _
          , subâ‚• â–¸H lemmaâ‚„
          âˆ™ â–¸á¶œÂ¹ â–¸t (lemmaâ‚‚ âˆ£ S âˆ£ p r)
          âˆ™ â–¸á¶œÂ¹ â–¸nr â‰¤-refl
          , â–¸s , wk-â–¸Ë¢ (step (step id)) â–¸S
          , â‰¤á¶œ-reflexive (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£))
          âˆ™ â‰¤-reflexive (trans (Â·-congÊ³ âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£) (sym (+-identityÊ³ _)))
          âˆ™ â‰¤-reflexive (trans (Â·-congÊ³ âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£) (sym (+-identityÊ³ _)))}
    where
    lemmaâ‚ : âˆ€ p r â†’ nrâ‚‚ p r â‰¤ p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™
    lemmaâ‚ p r = begin
      nrâ‚‚ p r                          â‰ˆË˜âŸ¨ Â·-identityÊ³ _ âŸ©
      nrâ‚‚ p r Â· ğŸ™                     â‰ˆË˜âŸ¨ +-identityÊ³ _ âŸ©
      nrâ‚‚ p r Â· ğŸ™ + ğŸ˜                 â‰ˆË˜âŸ¨ +-congË¡ nr-ğŸ˜ âŸ©
      nrâ‚‚ p r Â· ğŸ™ + nr p r ğŸ˜ ğŸ˜ ğŸ˜     â‰ˆË˜âŸ¨ nr-factoring âŸ© -- Should this be an inequality?
      nr p r ğŸ˜ ğŸ˜ ğŸ™                    â‰¤âŸ¨ nr-suc âŸ©
      ğŸ˜ + p Â· ğŸ™ + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆË˜âŸ¨ +-assoc _ _ _ âŸ©
      (ğŸ˜ + p Â· ğŸ™) + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ â‰ˆâŸ¨ +-congÊ³ (+-comm _ _) âŸ©
      (p Â· ğŸ™ + ğŸ˜) + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ â‰ˆâŸ¨ +-assoc _ _ _ âŸ©
      p Â· ğŸ™ + ğŸ˜ + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆâŸ¨ +-cong (Â·-identityÊ³ p) (+-identityË¡ _) âŸ©
      p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™            âˆ
      where
      open RPo â‰¤-poset
    lemmaâ‚‚ : âˆ€ q p r â†’ q Â· nrâ‚‚ p r â‰¤ q Â· p + (q Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™
    lemmaâ‚‚ q p r = begin
      q Â· nrâ‚‚ p r                     â‰¤âŸ¨ Â·-monotoneÊ³ (lemmaâ‚ p r) âŸ©
      q Â· (p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™)     â‰ˆâŸ¨ Â·-distribË¡-+ q p _ âŸ©
      q Â· p + q Â· r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆË˜âŸ¨ +-congË¡ (Â·-assoc _ _ _) âŸ©
      q Â· p + (q Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ âˆ
      where
      open RPo â‰¤-poset
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸star , â–¸S , Î³â‰¤) (starÊ·â‚• {E} {p} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (unitrecâ‚‘ {Î³ = Î´â€²} â–¸t _) â–¸S) â†’
    case inv-usage-starÊ· â–¸star of Î»
      Î´â‰¤ğŸ˜ â†’
    _ , _ , _ , â–¸H , â–¸t , â–¸S , (begin
      Î³                                                 â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤ğŸ˜)) âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ E ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ E) âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                      â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                            â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ Î·                            âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (unitrec-Î·â‚• {p} {E} {S} Î·-ok) =
    case inv-usage-unitrec â–¸t of Î»
      (invUsageUnitrec {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u _ ok Î´â‰¤) â†’
    _ , _ , _ , â–¸H , â–¸u , â–¸S , (begin
      Î³                                  â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·               â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (p Â·á¶œ Î´â‚ +á¶œ Î´â‚‚) +á¶œ Î· â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (+á¶œ-monotoneË¡
                                                        (Â·á¶œ-monotoneË¡ (no-erased-unitrec-Î· Î·-ok ok))))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (ğŸ˜ Â·á¶œ Î´â‚ +á¶œ Î´â‚‚) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E (+á¶œ-congÊ³ (Â·á¶œ-zeroË¡ Î´â‚)))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (ğŸ˜á¶œ +á¶œ Î´â‚‚) +á¶œ Î·      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E (+á¶œ-identityË¡ Î´â‚‚))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â‚‚ +á¶œ Î·              âˆ)
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (rflâ‚•â±¼ {E} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (Jâ‚‘ {Î³ = Î´â€²} â–¸u) â–¸S) â†’
    _ , _ , _ , â–¸H , â–¸u , â–¸S , (begin
      Î³                                                 â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (inv-usage-rfl â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ E) âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                      â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                            â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ Î·                            âˆ )}
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (rflâ‚•â‚– {E} {Eâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (Kâ‚‘ {Î³ = Î´â€²} â–¸u) â–¸S) â†’
    _ , _ , _ , â–¸H , â–¸u , â–¸S , (begin
      Î³                                                  â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²   â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (inv-usage-rfl â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²  â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ E) âŸ©
      (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²        â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                       â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€²                             â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Eâ€² Î´â€² +á¶œ Î·                             âˆ )}
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’áµ¥ (â–¸H , â–¸t , â–¸S , Î³â‰¤) rflâ‚•â‚‘ =
    case â–¸S of Î» {(() âˆ™ _)}

opaque

  â–¸-â‡’â‚™ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸ s) (d : s â‡’â‚™ sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸ sâ€²)
  â–¸-â‡’â‚™ â–¸s (varâ‚•â€² d) = âŠ¥-elim not-tracking-and-no-tracking
  â–¸-â‡’â‚™ {(m)} {Î³} {Î´} {Î·} (â–¸H , â–¸x , â–¸S , Î³â‰¤) (varâ‚• {E} {x} {S} {Eâ€²} d) =
    case â–¸-heapLookup d â–¸H lemmaâ‚‚ (â–¸âˆ£Sâˆ£â‰¢ğŸ˜ â–¸S) of Î»
      (Î´â€² , â–¸t , â–¸Hâ€²) â†’
    _ , _ , _
      , â–¸Hâ€² , â–¸t , â–¸S
      , let open RPo â‰¤á¶œ-poset
            EÎ´â€² = wká¶œ Eâ€² Î´â€²
        in  begin
          (Î³ , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰¤âŸ¨ +á¶œ-monotoneË¡ (update-monotoneË¡ xâ€² lemmaâ‚) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î· , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (update-congÊ³ (+-identityË¡ _)) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î· , xâ€² â‰” ğŸ˜ + Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰¡âŸ¨ cong (_+á¶œ (âˆ£Sâˆ£ Â·á¶œ EÎ´â€²)) (update-distrib-+á¶œ _ Î· ğŸ˜ _ xâ€²) âŸ©
          (((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) , xâ€² â‰” ğŸ˜) +á¶œ (Î· , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©)) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰¡âŸ¨ congâ‚‚ (Î» x y â†’ (x +á¶œ y) +á¶œ (âˆ£Sâˆ£ Â·á¶œ EÎ´â€²)) update-twice (update-self Î· xâ€²) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” ğŸ˜) +á¶œ Î·) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰¡âŸ¨ cong (Î» x â†’ (x +á¶œ Î·) +á¶œ (âˆ£Sâˆ£ Â·á¶œ EÎ´â€²)) ğŸ˜á¶œ,â‰”ğŸ˜ âŸ©
          (ğŸ˜á¶œ +á¶œ Î·) +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-identityË¡ Î·) âŸ©
          Î· +á¶œ âˆ£Sâˆ£ Â·á¶œ EÎ´â€²
            â‰ˆâŸ¨ +á¶œ-comm Î· _ âŸ©
          âˆ£Sâˆ£ Â·á¶œ EÎ´â€² +á¶œ Î· âˆ
    where
    xâ€² : Ptr m
    xâ€² = wkVar E x
    EÎ´ : Conâ‚˜ m
    EÎ´ = wká¶œ E Î´
    âˆ£Sâˆ£ : M
    âˆ£Sâˆ£ = âˆ£ S âˆ£
    lemmaâ‚ : Î³ â‰¤á¶œ (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î·
    lemmaâ‚ = begin
      Î³                                 â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£Sâˆ£ Â·á¶œ EÎ´ +á¶œ Î·                    â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (inv-usage-var â–¸x))) âŸ©
      âˆ£Sâˆ£ Â·á¶œ wká¶œ E (ğŸ˜á¶œ , x â‰” ğŸ™) +á¶œ Î· â‰¡âŸ¨ cong (Î» x â†’ âˆ£Sâˆ£ Â·á¶œ x +á¶œ Î·) (wkUsageVar E x) âŸ©
      âˆ£Sâˆ£ Â·á¶œ (ğŸ˜á¶œ , xâ€² â‰” ğŸ™) +á¶œ Î·         â‰¡Ë˜âŸ¨ cong (_+á¶œ Î·) (update-distrib-Â·á¶œ ğŸ˜á¶œ âˆ£Sâˆ£ ğŸ™ xâ€²) âŸ©
      (âˆ£Sâˆ£ Â·á¶œ ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£ Â· ğŸ™) +á¶œ Î·   â‰ˆâŸ¨ +á¶œ-congÊ³ (update-cong (Â·á¶œ-zeroÊ³ âˆ£Sâˆ£) (Â·-identityÊ³ âˆ£Sâˆ£)) âŸ©
      (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î·              âˆ
      where
      open RPo â‰¤á¶œ-poset
    lemmaâ‚‚ : Î³ âŸ¨ xâ€² âŸ© - âˆ£Sâˆ£ â‰¤ Î· âŸ¨ xâ€² âŸ©
    lemmaâ‚‚ = begin
      Î³ âŸ¨ xâ€² âŸ©                        â‰¤âŸ¨ lookup-monotone xâ€² lemmaâ‚ âŸ©
      ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î·) âŸ¨ xâ€² âŸ©     â‰¡âŸ¨ lookup-distrib-+á¶œ (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) Î· xâ€² âŸ©
      (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) âŸ¨ xâ€² âŸ© + Î· âŸ¨ xâ€² âŸ©  â‰¡âŸ¨ cong (_+ Î· âŸ¨ xâ€² âŸ©) (update-lookup ğŸ˜á¶œ xâ€²) âŸ©
      âˆ£Sâˆ£ + Î· âŸ¨ xâ€² âŸ©                    â‰ˆâŸ¨ +-comm âˆ£Sâˆ£ _ âŸ©
      Î· âŸ¨ xâ€² âŸ© + âˆ£Sâˆ£                    âˆ
      where
      open RPo â‰¤-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (appâ‚• {p} {E} {S}) =
    case inv-usage-app â–¸t of Î»
      (invUsageApp {Î´ = Î´â€²} {(Î·â€²)} â–¸t â–¸u Î´â‰¤) â†’
    _ , _ , _
      , â–¸H , â–¸t
      , âˆ˜â‚‘ â–¸u âˆ™ â–¸S
      , (begin
        Î³                                                      â‰¤âŸ¨ Î³â‰¤ âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                                   â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Î´â€² +á¶œ p Â·á¶œ Î·â€²) +á¶œ Î·                     â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ (wká¶œ E Î´â€² +á¶œ wká¶œ E (p Â·á¶œ Î·â€²)) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congË¡ (wk-Â·á¶œ E))) âŸ©
        âˆ£ S âˆ£ Â·á¶œ (wká¶œ E Î´â€² +á¶œ p Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î·               â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
        (âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î·      â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ E Î·â€² +á¶œ Î·       â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-comm _ _) âŸ©
        (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ E Î·â€² âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (fstâ‚• {E} {S}) =
    case inv-usage-fst â–¸t of Î»
      (invUsageFst {Î´ = Î´â€²} m eq â–¸t Î´â‰¤ mp-cond) â†’
    _ , _ , _
      , â–¸H , â–¸t , fstâ‚‘ (mp-cond refl) âˆ™ â–¸S
      , (begin
          Î³                                           â‰¤âŸ¨ Î³â‰¤ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î·                      â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ          â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (sndâ‚• {E} {S}) =
    case inv-usage-snd â–¸t of Î»
      (invUsageSnd {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
   _ , _ , _ , â–¸H , â–¸t , sndâ‚‘ âˆ™ â–¸S
     , (begin
         Î³                                            â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                        â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î·                       â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
         (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ           â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
   where
   open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (prodrecâ‚• {r} {p} {u} {E} {S}) =
    case inv-usage-prodrec â–¸t of Î»
      (invUsageProdrec {Î´ = Î´â€²} {Î· = Î·â€²} â–¸t â–¸u _ ok Î´â‰¤) â†’
    case substâ‚‚ (Î» x y â†’ _ âˆ™ x âˆ™ y â–¸ u)
           (Â·-identityË¡ (r Â· p))
           (Â·-identityË¡ r) â–¸u of Î»
      â–¸uâ€² â†’
    case no-erased-prodrec ok of
      Î» râ‰¢ğŸ˜ â†’
    _ , _ , _
      , â–¸H , â–¸-cong (â‰¢ğŸ˜â†’âŒâŒŸâ‰¡ğŸ™áµ râ‰¢ğŸ˜) â–¸t
      , prodrecâ‚‘ â–¸uâ€² râ‰¢ğŸ˜ âˆ™ â–¸S
      , (begin
         Î³                                                   â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                                â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (r Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (wká¶œ E (r Â·á¶œ Î´â€²) +á¶œ wká¶œ E Î·â€²) +á¶œ Î·          â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ âˆ£ S âˆ£ _ _) âŸ©
         (âˆ£ S âˆ£ Â·á¶œ wká¶œ E (r Â·á¶œ Î´â€²) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (r Â·á¶œ Î´â€²) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€² +á¶œ Î·   â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congË¡ (wk-Â·á¶œ E)) (+á¶œ-comm _ Î·) âŸ©
         âˆ£ S âˆ£ Â·á¶œ r Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€²     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-assoc âˆ£ S âˆ£ r _) âŸ©
         (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€²    âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (natrecâ‚• {p} {r} {s} {E} {S}) =
    case inv-usage-natrec â–¸t of Î» {
      (invUsageNatrec {Î´ = Î´â€²} {Î· = Î·â€²} {Î¸} â–¸z â–¸s â–¸n â–¸A Î´â‰¤nr P) â†’
    case substâ‚‚ (Î» x y â†’ _ âˆ™ x âˆ™ y â–¸ s) (Â·-identityË¡ p) (Â·-identityË¡ r) â–¸s of Î»
      â–¸sâ€² â†’
    case P of Î» {
      (invUsageNatrecNoNr _ _ _ _) â†’ âŠ¥-elim not-nr-and-no-nr ;
      (invUsageNatrecNr â¦ƒ (d-nr) â¦„) â†’
    case Dedicated-nr-propositional d-nr dedicatedNr of Î» {
      refl â†’
    _ , _ , _ , â–¸H , â–¸n , natrecâ‚‘ â–¸z â–¸sâ€² â–¸A âˆ™ â–¸S , (begin
      Î³                                                                        â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                                                    â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤nr)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² Î¸) +á¶œ Î·                                     â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E nrá¶œ-factoring)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrâ‚‚ p r Â·á¶œ Î¸ +á¶œ nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) +á¶œ Î·                    â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ (wká¶œ E (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)) +á¶œ Î·          â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
      (âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) +á¶œ Î·   â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congË¡ (wk-Â·á¶œ E)) (+á¶œ-comm _ _) âŸ©
      âˆ£ S âˆ£ Â·á¶œ (nrâ‚‚ p r Â·á¶œ wká¶œ E Î¸) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)   â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-assoc _ _ _) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ E Î¸ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) âˆ)}}}
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (unitrecâ‚• {p} {E} {S} no-Î·) =
    case inv-usage-unitrec â–¸t of Î»
      (invUsageUnitrec {Î´ = Î´â€²} {Î· = Î·â€²} â–¸t â–¸u _ ok Î´â‰¤) â†’
    case no-erased-unitrec no-Î· ok of Î»
      pâ‰¢ğŸ˜ â†’
    _ , _ , _ , â–¸H
      , â–¸-cong (â‰¢ğŸ˜â†’âŒâŒŸâ‰¡ğŸ™áµ pâ‰¢ğŸ˜) â–¸t
      , unitrecâ‚‘ â–¸u pâ‰¢ğŸ˜ âˆ™ â–¸S
      , (begin
          Î³                                                  â‰¤âŸ¨ Î³â‰¤ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                              â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ E (p Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ (wká¶œ E (p Â·á¶œ Î´â€²) +á¶œ wká¶œ E Î·â€²) +á¶œ Î·        â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (wk-Â·á¶œ E))) âŸ©
          âˆ£ S âˆ£  Â·á¶œ (p Â·á¶œ wká¶œ E Î´â€² +á¶œ wká¶œ E Î·â€²) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
          (âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ E Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€²) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
          âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ E Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€² +á¶œ Î·   â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
          (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î·â€²  âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (Jâ‚• {E} {S}) =
    case inv-usage-J â–¸t of Î» {
      (invUsageJâ‚€â‚ e _ _ _ _ _ _ _ _ _) â†’ âŠ¥-elim (no-erased-J-some e) ;
      (invUsageJâ‚€â‚‚ e _ _ _ _ _ _ _) â†’ âŠ¥-elim (no-erased-J-all e) ;
      (invUsageJ {Î³â‚‚} {Î³â‚ƒ} {Î³â‚„} {Î³â‚…} {Î³â‚†} _ _ _ _ _ â–¸u _ â–¸w Î´â‰¤) â†’
        _ , _ , _ , â–¸H , â–¸w , Jâ‚‘ â–¸u âˆ™ â–¸S , (begin
         Î³                                                         â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                                     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚‚ +á¶œ Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E (Â·á¶œ-distribË¡-+á¶œ Ï‰ _ _))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ Î³â‚„ +á¶œ Ï‰ Â·á¶œ (Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·           â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E (+á¶œ-monotoneÊ³ Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ Î³â‚„ +á¶œ Ï‰ Â·á¶œ Î³â‚†) +á¶œ Î·                   â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ E)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (wká¶œ E (Ï‰ Â·á¶œ Î³â‚„) +á¶œ wká¶œ E (Ï‰ Â·á¶œ Î³â‚†)) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-cong (wk-Â·á¶œ E) (wk-Â·á¶œ E))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚†) +á¶œ Î·             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (+á¶œ-monotoneË¡ (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (ğŸ™ Â·á¶œ wká¶œ E Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚†) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (Â·á¶œ-identityË¡ _))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (wká¶œ E Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚†) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
         (âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„ +á¶œ âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚†) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-comm _ _) âŸ©
         (âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚† +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
         âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚† +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„ +á¶œ Î·           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
         (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„          âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (Kâ‚• {E} {S}) =
    case inv-usage-K â–¸t of Î» {
      (invUsageKâ‚€â‚ e _ _ _ _ _ _ _) â†’ âŠ¥-elim (no-erased-K-some e) ;
      (invUsageKâ‚€â‚‚ e _ _ _ _ _ _) â†’ âŠ¥-elim (no-erased-K-all e) ;
      (invUsageK {Î³â‚‚} {Î³â‚ƒ} {Î³â‚„} {Î³â‚…} _ _ _ _ _ â–¸u â–¸v Î´â‰¤) â†’
        _ , _ , _ , â–¸H , â–¸v , Kâ‚‘ â–¸u âˆ™ â–¸S , (begin
         Î³                                                         â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                                     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚‚ +á¶œ Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ E (Ï‰ Â·á¶œ (Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-Â·á¶œ E)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E (Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ E (+á¶œ-comm _ _)))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E (Î³â‚… +á¶œ Î³â‚„)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-+á¶œ E))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ (wká¶œ E Î³â‚… +á¶œ wká¶œ E Î³â‚„)) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-distribË¡-+á¶œ _ _ _)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E Î³â‚… +á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚„) +á¶œ Î·             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (+á¶œ-monotoneÊ³ (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E Î³â‚… +á¶œ ğŸ™ Â·á¶œ wká¶œ E Î³â‚„) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-identityË¡ _))) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ E Î³â‚… +á¶œ wká¶œ E Î³â‚„) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
         (âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚… +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
         âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ E Î³â‚… +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„ +á¶œ Î·           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
         (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ E Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î³â‚„     âˆ) }
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) []-congâ‚• =
    case inv-usage-[]-cong â–¸t of Î»
      (invUsage-[]-cong _ _ _ _ ok _) â†’
    âŠ¥-elim (no-[]-cong ok)


opaque

  â–¸-â‡’â‚› : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸ s) (d : s â‡’â‚› sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸ sâ€²)
  â–¸-â‡’â‚› {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , Î³â‰¤) (sucâ‚• {E} {k} x) =
    case inv-usage-suc â–¸t of Î»
      (invUsageSuc {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
    _ , _ , _ , â–¸H , â–¸t , sucâ‚‘ âˆ™ â–¸S , (begin
      Î³ â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ sucâ‚› k âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                            â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ E Î´â‰¤)) âŸ©
      âˆ£ sucâ‚› k âˆ£ Â·á¶œ wká¶œ E Î´â€² +á¶œ Î·                           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
      (âˆ£ sucâ‚› k âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ               â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
      (âˆ£ sucâ‚› k âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´â€² +á¶œ Î· +á¶œ âˆ£ sucâ‚› k âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚› {Î³} {Î´} (â–¸H , â–¸t , _âˆ™_ {Î³ = Î·} â–¸e â–¸S , Î³â‰¤) (numâ‚• {E} {S} x) =
    case â–¸e of Î» {
      sucâ‚‘ â†’
    _ , _ , _ , â–¸H , sucâ‚˜ â–¸t , â–¸S , (begin
      Î³                                          â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
      (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ E Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ          â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ E Î´ +á¶œ Î·                      âˆ) }
    where
    open RPo â‰¤á¶œ-poset


opaque

  -- Well-resourced states evaluate to well-resourced states

  â–¸-â‡’ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸ s) (d : s â‡’ sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸ sâ€²)
  â–¸-â‡’ â–¸s (â‡’â‚™ d) = â–¸-â‡’â‚™ â–¸s d
  â–¸-â‡’ â–¸s (â‡’áµ¥ d) = â–¸-â‡’áµ¥ â–¸s d
  â–¸-â‡’ â–¸s (â‡’â‚› d) = â–¸-â‡’â‚› â–¸s d

opaque

  â–¸-â‡’* : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸ s) (d : s â‡’* sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸ sâ€²)
  â–¸-â‡’* â–¸s id =
    _ , _ , _ , â–¸s
  â–¸-â‡’* â–¸s (d â‡¨ dâ€²) =
    case â–¸-â‡’ â–¸s d of Î»
      (_ , _ , _ , â–¸sâ€²) â†’
    â–¸-â‡’* â–¸sâ€² dâ€²
