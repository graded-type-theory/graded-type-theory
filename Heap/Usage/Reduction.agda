------------------------------------------------------------------------
-- Properties of the usage relation for Heaps, Stacks and States
-- and the reduction relation with resource tracking.
------------------------------------------------------------------------

open import Graded.Modality
open import Graded.Usage.Restrictions
open import Heap.Options
open import Definition.Typed.Variant
open import Tools.Bool
import Graded.Mode

module Heap.Usage.Reduction
  {a} {M : Set a} {ğ•„ : Modality M}
  (type-variant : Type-variant)
  (UR : Usage-restrictions ğ•„)
  (erased-heap : Bool)
  (opts : Options)
  (open Type-variant type-variant)
  (open Usage-restrictions UR)
  (open Graded.Mode ğ•„)
  (open Options opts)
  (open Modality ğ•„)
  (UnitÊ·-Î·â†’ : âˆ€ {p q} â†’ UnitÊ·-Î· â†’ Unitrec-allowed ğŸ™áµ p q â†’ p â‰¤ ğŸ˜)
  â¦ƒ _ : Track-resources â¦„
  â¦ƒ nr-avail : Nr-available â¦„
  â¦ƒ _ : Has-factoring-nr M semiring-with-meet â¦ƒ has-nr nr-avail â¦„ â¦„
  â¦ƒ _ : Has-well-behaved-zero M semiring-with-meet â¦„
  where

open import Graded.Modality.Dedicated-nr ğ•„

private instance
  _ : Has-nr M semiring-with-meet
  _ = has-nr nr-avail

  d-nr : Dedicated-nr
  d-nr = dedicated-nr nr-avail

open import Tools.Empty
open import Tools.Fin
open import Tools.Function
open import Tools.Product
open import Tools.PropositionalEquality
open import Tools.Unit
import Tools.Reasoning.PartialOrder as RPo

open import Definition.Untyped M

open import Heap.Untyped type-variant UR
open import Heap.Untyped.Properties type-variant UR
open import Heap.Reduction type-variant UR opts
open import Heap.Usage type-variant UR erased-heap
open import Heap.Usage.Properties type-variant UR erased-heap
open import Heap.Usage.Weakening type-variant UR erased-heap

open import Graded.Context ğ•„
open import Graded.Context.Properties ğ•„
open import Graded.Context.Weakening ğ•„
open import Graded.Modality.Nr-instances
open import Graded.Modality.Properties ğ•„
open import Graded.Usage ğ•„ UR
open import Graded.Usage.Erased-matches
open import Graded.Usage.Inversion ğ•„ UR
open import Graded.Usage.Properties ğ•„ UR
open import Graded.Usage.Weakening ğ•„ UR

private variable
  Î³ Î´ Î· : Conâ‚˜ _
  s sâ€² : State _ _ _
  m : Mode
  A B t u v w : Term _
  p q : M
  Ï : Wk _ _
  H : Heap _ _
  S : Stack _


opaque

  â–¸-â‡’áµ¥ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸[ m ] s) (d : s â‡’áµ¥ sâ€²) â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] sâ€²)
  â–¸-â‡’áµ¥ {Î´} {m} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (lamâ‚• {p} {Ï} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (âˆ˜â‚‘ {Î³ = Î³â€²} â–¸u , mâ€²â‰¤) â–¸S) â†’
    case inv-usage-lam â–¸t of Î»
      (invUsageLam {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
    _ , _ , _ , _
      , subâ‚• â–¸H (â‰¤á¶œ-trans Î³â‰¤
           (â‰¤á¶œ-reflexive (â‰ˆá¶œ-trans (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)))
             (â‰ˆá¶œ-sym (â‰ˆá¶œ-trans (+á¶œ-congË¡ (Â·á¶œ-assoc _ _ _))
               (+á¶œ-assoc _ _ _))))))
      âˆ™ â–¸á¶œáµáµ– â–¸u mâ€²â‰¤
      , â–¸t , wk-â–¸Ë¢ (step id) â–¸S
      , subst (_ â‰¤áµ_) (trans (Â·-identityÊ³ _) (wk-âˆ£Sâˆ£ (step id) S)) mâ‰¤
      , (begin
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· âˆ™ âˆ£ S âˆ£ Â· p                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âˆ™ â‰¤-refl âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ âˆ£ S âˆ£ Â· p                      â‰ˆË˜âŸ¨ â‰ˆá¶œ-refl âˆ™ Â·-congÊ³ (Â·-identityÊ³ _) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ (âˆ£ S âˆ£ Â· ğŸ™) Â· p                â‰ˆË˜âŸ¨ â‰ˆá¶œ-refl âˆ™ Â·-congÊ³ (â‰¤áµ-Â·âŒœâŒ mâ‰¤) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ ((âˆ£ S âˆ£ Â· ğŸ™) Â· âŒœ m âŒ) Â· p      â‰ˆâŸ¨ â‰ˆá¶œ-refl âˆ™ Â·-congÊ³ (Â·-congÊ³ (Â·-identityÊ³ _)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ (âˆ£ S âˆ£ Â· âŒœ m âŒ) Â· p            â‰ˆâŸ¨ â‰ˆá¶œ-refl âˆ™ Â·-assoc _ _ _ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ âˆ£ S âˆ£ Â· âŒœ m âŒ Â· p              â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (wk-âˆ£Sâˆ£ (step id) S)) âˆ™ Â·-congÊ³ (wk-âˆ£Sâˆ£ (step id) S) âŸ©
          âˆ£ wk1Ë¢ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ âˆ£ wk1Ë¢ S âˆ£ Â· âŒœ m âŒ Â· p     â‰ˆË˜âŸ¨ â‰ˆá¶œ-refl âˆ™ +-identityÊ³ _ âŸ©
          âˆ£ wk1Ë¢ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· âˆ™ âˆ£ wk1Ë¢ S âˆ£ Â· âŒœ m âŒ Â· p + ğŸ˜ âˆ )}
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} {m} (â–¸H , â–¸t , _âˆ™_ {m = mâ€²} {Î³ = Î·} (â–¸e , mâ€²â‰¤) â–¸S , mâ‰¤ , Î³â‰¤) (prodË¢â‚•â‚ {p} {Ï} {S}) =
    case inv-usage-prodË¢ â–¸t of Î»
      (invUsageProdË¢ {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u Î´â‰¤) â†’
    case â–¸e of Î» {
      (fstâ‚‘ mp-cond) â†’
    _ , _ , _ , _ , â–¸H , â–¸t , â–¸S
      , (case singleton m of Î» {
          (ğŸ˜áµ , refl) â†’
          subst (_ â‰¤áµ_) (Â·-identityÊ³ _) mâ‰¤
        , lemma (trans (sym (Â·-identityÊ³ _)) (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤))
          ;
          (ğŸ™áµ , refl) â†’
         case singleton mâ€² of Î» {
           (ğŸ˜áµ , refl) â†’
           subst (_ â‰¤áµ_) (sym (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ€²â‰¤)) â‰¤áµğŸ˜
         , lemma (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ€²â‰¤)
           ;
           (ğŸ™áµ , refl) â†’
           subst (_â‰¤áµ _) (sym (â‰¢ğŸ˜â†’âŒâŒŸâ‰¡ğŸ™áµ Î» {refl â†’ ğŸ˜â‰°ğŸ™ (mp-cond refl)})) ğŸ™áµâ‰¤áµ
         , (begin
             Î³                                          â‰¤âŸ¨ Î³â‰¤ âŸ©
             (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ                â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-identityÊ³ _) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                      â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â‚ âˆ§á¶œ Î´â‚‚) +á¶œ Î·        â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (âˆ§á¶œ-decreasingË¡ _ _))) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â‚) +á¶œ Î·              â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (Â·á¶œ-monotoneË¡ (mp-cond refl)))) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (ğŸ™ Â·á¶œ Î´â‚) +á¶œ Î·              â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (Â·á¶œ-identityË¡ _))) âŸ©
             âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î´â‚ +á¶œ Î· âˆ )}})}
    where
    open RPo â‰¤á¶œ-poset
    lemma : âˆ€ {Î´â€²} â†’ âˆ£ S âˆ£ â‰¡ ğŸ˜ â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·
    lemma {Î´â€²} âˆ£Sâˆ£â‰¡ğŸ˜ = begin
      Î³                                          â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ _  â‰¡âŸ¨ cong (Î» x â†’ (x Â· ğŸ™) Â·á¶œ _ +á¶œ _ +á¶œ x Â·á¶œ _) âˆ£Sâˆ£â‰¡ğŸ˜ âŸ©
      (ğŸ˜ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜ Â·á¶œ _         â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-zeroË¡ _)) (+á¶œ-congË¡ (Â·á¶œ-zeroË¡ _)) âŸ©
      ğŸ˜ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ                   â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-zeroË¡ _) (+á¶œ-identityÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î·                                   â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
      ğŸ˜ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·                        â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·                    âˆ

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (prodË¢â‚•â‚‚ {p} {Ï} {S}) =
    case inv-usage-prodË¢ â–¸t of Î»
      (invUsageProdË¢ {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u Î´â‰¤) â†’
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (sndâ‚‘ , mâ€²â‰¤) â–¸S) â†’
    _ , _ , _ , _ , â–¸H , â–¸u , â–¸S
      , subst (_ â‰¤áµ_) (Â·-identityÊ³ _) mâ‰¤
      , (begin
          Î³ â‰¤âŸ¨ Î³â‰¤ âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ  â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ           â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â‚ âˆ§á¶œ Î´â‚‚) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (âˆ§á¶œ-decreasingÊ³ (p Â·á¶œ Î´â‚) Î´â‚‚))) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â‚‚ +á¶œ Î·                       âˆ) }
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (prodÊ·â‚• {p} {tâ‚} {Ï} {r} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (prodrecâ‚‘ {Î³ = Î³â€²} â–¸u râ‰¢ğŸ˜ , mâ€²â‰¤) â–¸S) â†’
    case inv-usage-prodÊ· â–¸t of Î»
      (invUsageProdÊ· {Î´ = Î´â€²} {Î· = Î·â€²} â–¸tâ‚ â–¸tâ‚‚ Î´â‰¤) â†’
    let Î³â‰¤â€² : Î³ â‰¤á¶œ ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p + (âˆ£ S âˆ£ Â· r) Â· ğŸ˜) Â·á¶œ wká¶œ Ï Î´â€²
        Î³â‰¤â€² = begin
          Î³                                                                                                      â‰¤âŸ¨ Î³â‰¤ âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                                                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                                         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ (wká¶œ Ï (p Â·á¶œ Î´â€²) +á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                                 â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (wk-Â·á¶œ Ï))) âŸ©
          (âˆ£ S âˆ£ Â· r) Â·á¶œ (p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                                   â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ (âˆ£ S âˆ£ Â· r) _ _) âŸ©
          ((âˆ£ S âˆ£ Â· r) Â·á¶œ p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                    â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (Â·á¶œ-assoc (âˆ£ S âˆ£ Â· r) p _)) âŸ©
          (((âˆ£ S âˆ£ Â· r) Â· p) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                   â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-assoc âˆ£ S âˆ£ r p))) âŸ©
          ((âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                     â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
          (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²                     â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-comm _ _) âŸ©
          (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€² +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ Ï Î´â€²                     â‰ˆË˜âŸ¨ +á¶œ-assoc _ _ _ âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p) Â·á¶œ wká¶œ Ï Î´â€²                   â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-congÊ³ (+-identityÊ³ _)) âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p + ğŸ˜) Â·á¶œ wká¶œ Ï Î´â€²               â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-congÊ³ (+-congË¡ (Â·-zeroÊ³ _))) âŸ©
          ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ (âˆ£ S âˆ£ Â· r Â· p + (âˆ£ S âˆ£ Â· r) Â· ğŸ˜) Â·á¶œ wká¶œ Ï Î´â€² âˆ
        â–¸á¶œtâ‚ = substâ‚‚ (Î» x y â†’ (_ â¨¾ x â–¸á¶œ (y , _)))
                (trans (Â·-assoc _ _ _) (sym (trans (+-congË¡ (Â·-zeroÊ³ _)) (+-identityÊ³ _))))
                (Â·-assoc _ _ _) (â–¸á¶œáµáµ– â–¸tâ‚ mâ‰¤)
    in  _ , _ , _ , _
          , subâ‚• â–¸H Î³â‰¤â€² âˆ™ â–¸á¶œtâ‚ âˆ™ â–¸á¶œáµ â–¸tâ‚‚ mâ‰¤
          , â–¸u , wk-â–¸Ë¢ (step (step id)) â–¸S
          , subst (_ â‰¤áµ_) (wk-âˆ£Sâˆ£ (step (step id)) S) mâ€²â‰¤
          , â‰¤á¶œ-reflexive ((â‰ˆá¶œ-trans (+á¶œ-comm Î· _) (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S))))
              âˆ™ trans (Â·-congÊ³ (sym (â‰¤áµ-Â·âŒœâŒ mâ€²â‰¤))) (trans (Â·-assoc _ _ _)
                 (trans (Â·-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S)) (sym (+-identityÊ³ _))))
              âˆ™ trans (Â·-congÊ³ (sym (â‰¤áµ-Â·âŒœâŒ mâ€²â‰¤))) (trans (Â·-assoc _ _ _)
                  (trans (Â·-congÊ³ (wk-âˆ£Sâˆ£ (step (step id)) S)) (sym (+-identityÊ³ _))))) }
      where
      open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (zeroâ‚• {Ï} {p} {r} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (natrecâ‚‘ {Î³ = Î³â€²} {Î´ = Î´â€²} â–¸z â–¸s â–¸A , mâ€²â‰¤) â–¸S) â†’
    _ , _ , _ , _ , â–¸H , â–¸z , â–¸S , mâ€²â‰¤ , (begin
      Î³                                                                       â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (inv-usage-zero â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ Ï ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ï) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                            â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                                  â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ïâ€² (nrá¶œ-zero â‰¤á¶œ-refl))) âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€²                                                  â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î³â€² +á¶œ Î·                                                  âˆ) }
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (sucâ‚• {Ï} {p} {r} {s} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (natrecâ‚‘ {Î³ = Î³â€²} {m} {Î´ = Î´â€²} â–¸z â–¸s â–¸A , mâ€²â‰¤) â–¸S) â†’
    case inv-usage-suc â–¸t of Î»
      (invUsageSuc {Î´ = Î¸} â–¸t Î´â‰¤Î¸) â†’
    case wk-âˆ£Sâˆ£ (step (step id)) S of Î»
      âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£ â†’
    case natrecâ‚˜
           (wkUsage (step id) â–¸z)
           (wkUsage (liftn (step id) 2) â–¸s)
           (var {x = x0})
           (wkUsage (lift (step id)) â–¸A) of Î»
      â–¸nr â†’
    let lemmaâ‚„ : âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)
        lemmaâ‚„ = begin
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                             â‰¤âŸ¨ Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ïâ€² nrá¶œ-suc) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (Î´â€² +á¶œ p Â·á¶œ ğŸ˜á¶œ +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)      â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ïâ€² (+á¶œ-congË¡ (+á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ p)))) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (Î´â€² +á¶œ ğŸ˜á¶œ +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)           â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ïâ€² (+á¶œ-congË¡ (+á¶œ-identityË¡ _))) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (Î´â€² +á¶œ r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)                 â‰ˆâŸ¨ Â·á¶œ-congË¡ (wk-+á¶œ Ïâ€²) âŸ©
           âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ïâ€² Î´â€² +á¶œ wká¶œ Ïâ€² (r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ))        â‰ˆâŸ¨ Â·á¶œ-distribË¡-+á¶œ _ _ _ âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (r Â·á¶œ  nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) â‰ˆâŸ¨ +á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-Â·á¶œ Ïâ€²)) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ r Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)  â‰ˆË˜âŸ¨ +á¶œ-congË¡ (Â·á¶œ-assoc _ _ _) âŸ©
           âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ) âˆ
        lemmaâ‚… : Î³ â‰¤á¶œ ((âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ Î·) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ) Â·á¶œ wká¶œ Ï Î¸
        lemmaâ‚… = begin
           Î³
             â‰¤âŸ¨ Î³â‰¤ âŸ©
           (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)
             â‰¤âŸ¨ +á¶œ-monotone (Â·á¶œ-monotone (wk-â‰¤á¶œ Ï Î´â‰¤Î¸) (lemmaâ‚ƒ âˆ£ S âˆ£ p r mâ€²â‰¤)) (+á¶œ-monotoneÊ³ lemmaâ‚„) âŸ©
           (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ) Â·á¶œ wká¶œ Ï Î¸ +á¶œ Î· +á¶œ (âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ))
             â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
           (Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ) Â·á¶œ wká¶œ Ï Î¸
             â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-assoc _ _ _) âŸ©
           ((Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ) Â·á¶œ wká¶œ Ï Î¸
             â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-congÊ³ (+á¶œ-comm _ _)) âŸ©
           ((âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ Î·) +á¶œ (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ïâ€² (nrá¶œ p r Î³â€² Î´â€² ğŸ˜á¶œ)) +á¶œ (âˆ£ S âˆ£ Â· p + (âˆ£ S âˆ£ Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ) Â·á¶œ wká¶œ Ï Î¸ âˆ
        lemmaâ‚† : âˆ€ q â†’ âˆ£ S âˆ£ Â· q â‰¡ âˆ£ wk2Ë¢ S âˆ£ Â· âŒœ m âŒ Â· q + ğŸ˜
        lemmaâ‚† _ = trans (Â·-congÊ³ (sym (â‰¤áµ-Â·âŒœâŒ mâ€²â‰¤)))
                     (trans (Â·-assoc _ _ _) (trans (Â·-congÊ³ âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£)
                       (sym (+-identityÊ³ _))))
    in  _ , _ , _ , _
          , subâ‚• â–¸H lemmaâ‚…
          âˆ™ subá¶œ (â–¸á¶œáµ â–¸t mâ‰¤) (lemmaâ‚ƒ âˆ£ S âˆ£ p r mâ€²â‰¤)
          âˆ™ subst (Î» x â†’ nrá¶œ p r (Î³â€² âˆ™ ğŸ˜) (Î´â€² âˆ™ ğŸ˜) (ğŸ˜á¶œ âˆ™ âŒœ m âŒ) â¨¾ âˆ£ S âˆ£ Â· r â–¸á¶œ
                         (x , natrec p _ r _ _ _ _ , lift Ïâ€²))
              (trans (sym (Â·-assoc _ _ _)) (Â·-congÊ³ (â‰¤áµ-âŒœâŒÂ· mâ€²â‰¤)))
              (â–¸á¶œ â–¸nr (â‰¤-reflexive (trans (sym (Â·-assoc _ _ _)) (Â·-congÊ³ (â‰¤áµ-âŒœâŒÂ· mâ€²â‰¤)))))
          , â–¸s , wk-â–¸Ë¢ (step (step id)) â–¸S
          , subst (_ â‰¤áµ_) âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£ mâ€²â‰¤
          , â‰¤á¶œ-reflexive (+á¶œ-congÊ³ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡âˆ£â†‘Â²Sâˆ£))
          âˆ™ â‰¤-reflexive (lemmaâ‚† p)
          âˆ™ â‰¤-reflexive (lemmaâ‚† r) }
    where
    lemmaâ‚ : âˆ€ p r â†’ nrâ‚‚ p r â‰¤ p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™
    lemmaâ‚ p r = begin
      nrâ‚‚ p r                          â‰ˆË˜âŸ¨ Â·-identityÊ³ _ âŸ©
      nrâ‚‚ p r Â· ğŸ™                     â‰ˆË˜âŸ¨ +-identityÊ³ _ âŸ©
      nrâ‚‚ p r Â· ğŸ™ + ğŸ˜                 â‰ˆË˜âŸ¨ +-congË¡ nr-ğŸ˜ âŸ©
      nrâ‚‚ p r Â· ğŸ™ + nr p r ğŸ˜ ğŸ˜ ğŸ˜     â‰ˆË˜âŸ¨ nr-factoring âŸ© -- Should this be an inequality?
      nr p r ğŸ˜ ğŸ˜ ğŸ™                    â‰¤âŸ¨ nr-suc âŸ©
      ğŸ˜ + p Â· ğŸ™ + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆË˜âŸ¨ +-assoc _ _ _ âŸ©
      (ğŸ˜ + p Â· ğŸ™) + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ â‰ˆâŸ¨ +-congÊ³ (+-comm _ _) âŸ©
      (p Â· ğŸ™ + ğŸ˜) + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ â‰ˆâŸ¨ +-assoc _ _ _ âŸ©
      p Â· ğŸ™ + ğŸ˜ + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆâŸ¨ +-cong (Â·-identityÊ³ p) (+-identityË¡ _) âŸ©
      p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™            âˆ
      where
      open RPo â‰¤-poset
    lemmaâ‚‚ : âˆ€ q p r â†’ q Â· nrâ‚‚ p r â‰¤ q Â· p + (q Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™
    lemmaâ‚‚ q p r = begin
      q Â· nrâ‚‚ p r                     â‰¤âŸ¨ Â·-monotoneÊ³ (lemmaâ‚ p r) âŸ©
      q Â· (p + r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™)     â‰ˆâŸ¨ Â·-distribË¡-+ q p _ âŸ©
      q Â· p + q Â· r Â· nr p r ğŸ˜ ğŸ˜ ğŸ™   â‰ˆË˜âŸ¨ +-congË¡ (Â·-assoc _ _ _) âŸ©
      q Â· p + (q Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ™ âˆ
      where
      open RPo â‰¤-poset
    lemmaâ‚ƒ : âˆ€ q p r â†’ m â‰¤áµ q â†’ q Â· nrâ‚‚ p r â‰¤ q Â· p + (q Â· r) Â· nr p r ğŸ˜ ğŸ˜ âŒœ m âŒ
    lemmaâ‚ƒ q p r ğŸ™áµâ‰¤áµ = lemmaâ‚‚ q p r
    lemmaâ‚ƒ _ p r ğŸ˜áµâ‰¤áµğŸ˜ = begin
      ğŸ˜ Â· nrâ‚‚ p r                     â‰ˆâŸ¨ Â·-zeroË¡ _ âŸ©
      ğŸ˜                               â‰ˆË˜âŸ¨ +-identityÊ³ ğŸ˜ âŸ©
      ğŸ˜ + ğŸ˜                           â‰ˆË˜âŸ¨ +-cong (Â·-zeroË¡ p) (Â·-zeroË¡ _) âŸ©
      ğŸ˜ Â· p + ğŸ˜ Â· r Â· nr p r ğŸ˜ ğŸ˜ ğŸ˜   â‰ˆË˜âŸ¨ +-congË¡ (Â·-assoc _ _ _) âŸ©
      ğŸ˜ Â· p + (ğŸ˜ Â· r) Â· nr p r ğŸ˜ ğŸ˜ ğŸ˜ âˆ
      where
      open RPo â‰¤-poset
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸star , â–¸S , mâ‰¤ , Î³â‰¤) (starÊ·â‚• {Ï} {p} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (unitrecâ‚‘ {Î³ = Î´â€²} â–¸t _ _ , mâ€²â‰¤) â–¸S) â†’
    case inv-usage-starÊ· â–¸star of Î»
      Î´â‰¤ğŸ˜ â†’
    _ , _ , _ , _ , â–¸H , â–¸t , â–¸S , mâ€²â‰¤ , (begin
      Î³                                                 â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤ğŸ˜)) âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ Ï ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ï) âŸ©
      (âˆ£ S âˆ£ Â· p) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                      â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                            â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ Î·                            âˆ) }
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (unitrec-Î·â‚• {p} {Ï} {S} Î·-ok) =
    case inv-usage-unitrec â–¸t of Î»
      (invUsageUnitrec {Î´ = Î´â‚} {Î· = Î´â‚‚} â–¸t â–¸u _ ok Î´â‰¤) â†’
    _ , _ , _ , _ , â–¸H , â–¸u , â–¸S , mâ‰¤ , lemma _ mâ‰¤ Î´â‰¤ ok
    where
    open RPo â‰¤á¶œ-poset
    lemma : âˆ€ {Î´â‚ Î´â‚‚} m â†’ m â‰¤áµ âˆ£ S âˆ£ â†’ Î´ â‰¤á¶œ p Â·á¶œ Î´â‚ +á¶œ Î´â‚‚
          â†’ Unitrec-allowed m p q
          â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â‚‚ +á¶œ Î·
    lemma {Î´â‚‚} ğŸ˜áµ mâ‰¤ Î´â‰¤ ok = begin
      Î³                      â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤)) âŸ©
      ğŸ˜ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î·                â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
      ğŸ˜ Â·á¶œ wká¶œ Ï Î´â‚‚ +á¶œ Î·     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â‚‚ +á¶œ Î· âˆ
    lemma {Î´â‚} {Î´â‚‚} ğŸ™áµ mâ‰¤ Î´â‰¤ ok = begin
      Î³                                  â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·               â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â‚ +á¶œ Î´â‚‚) +á¶œ Î· â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (+á¶œ-monotoneË¡
                                                        (Â·á¶œ-monotoneË¡ (UnitÊ·-Î·â†’ Î·-ok ok))))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (ğŸ˜ Â·á¶œ Î´â‚ +á¶œ Î´â‚‚) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (+á¶œ-congÊ³ (Â·á¶œ-zeroË¡ Î´â‚)))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (ğŸ˜á¶œ +á¶œ Î´â‚‚) +á¶œ Î·      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (+á¶œ-identityË¡ Î´â‚‚))) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â‚‚ +á¶œ Î·              âˆ

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (rflâ‚•â±¼ {Ï} {p} {q} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (Jâ‚‘ {Î³ = Î´â€²} â–¸u , mâ€²â‰¤) â–¸S) â†’
    _ , _ , _ , _ , â–¸H , â–¸u , â–¸S , mâ€²â‰¤  , (begin
      Î³                                                            â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-J em p q) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²  â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (inv-usage-rfl â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-J em p q) Â·á¶œ wká¶œ Ï ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² â‰¡âŸ¨ cong (Î» x â†’ (_ Â· _) Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ï) âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-J em p q) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²       â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                                 â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                                       â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ Î·                                       âˆ )}
    where
    em : Erased-matches
    em = erased-matches-for-J ğŸ™áµ
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (rflâ‚•â‚– {Ï} {p} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} (Kâ‚‘ {Î³ = Î´â€²} â–¸u , mâ€²â‰¤) â–¸S) â†’
    _ , _ , _ , _ , â–¸H , â–¸u , â–¸S , mâ€²â‰¤ , (begin
      Î³                                                           â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-K em p) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²   â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (inv-usage-rfl â–¸t))) âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-K em p) Â·á¶œ wká¶œ Ï ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²  â‰¡âŸ¨ cong (Î» x â†’ (_ Â· _) Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ï) âŸ©
      (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-K em p) Â·á¶œ ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²        â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                                â‰ˆâŸ¨ +á¶œ-identityË¡ _ âŸ©
      Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€²                                      â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² Î´â€² +á¶œ Î·                                      âˆ )}
    where
    em : Erased-matches
    em = erased-matches-for-K ğŸ™áµ
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’áµ¥ {Î³} {Î´} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (rflâ‚•â‚‘ {Ï} {Ïâ€²} {S}) =
    case â–¸S of Î» {
      (_âˆ™_ {Î³ = Î·} ([]-congâ‚‘ ok , mâ€²â‰¤) â–¸S) â†’
    _ , _ , _ , _ , â–¸H , rflâ‚˜ , â–¸S , mâ€²â‰¤ , (begin
      Î³                                          â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
      ğŸ˜ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ                    â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-zeroË¡ _) (+á¶œ-identityÊ³ _) âŸ©
      ğŸ˜á¶œ +á¶œ Î·                                    â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroÊ³ _) âŸ©
      âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ +á¶œ Î·                           â‰¡Ë˜âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ïâ€²) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ïâ€² ğŸ˜á¶œ +á¶œ Î· âˆ) }
    where
    open RPo â‰¤á¶œ-poset

opaque

  â–¸-â‡’â‚™ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸[ m ] s) (d : s â‡’â‚™ sâ€²) â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] sâ€²)
  â–¸-â‡’â‚™ â–¸s (varâ‚•â€² d) = âŠ¥-elim not-tracking-and-no-tracking
  â–¸-â‡’â‚™ {(n)} {Î³} {Î´} {Î·} {m} (â–¸H , â–¸x , â–¸S , mâ‰¤ , Î³â‰¤) (varâ‚• {Ï} {x} {S} {Ïâ€²} d) =
    case â–¸-heapLookup d â–¸H lemmaâ‚‚ of Î»
      (mâ€² , Î´â€² , â–¸t , â–¸Hâ€² , mâ€²â‰¤) â†’
    _ , _ , _ , _
      , â–¸Hâ€² , â–¸t , â–¸S , mâ€²â‰¤
      , let open RPo â‰¤á¶œ-poset
            ÏÎ´â€² = wká¶œ Ïâ€² Î´â€²
        in  begin
          (Î³ , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰¤âŸ¨ +á¶œ-monotoneË¡ (update-monotoneË¡ xâ€² lemmaâ‚) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î· , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (update-congÊ³ (+-identityË¡ _)) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î· , xâ€² â‰” ğŸ˜ + Î· âŸ¨ xâ€² âŸ©) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰¡âŸ¨ cong (_+á¶œ (âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²)) (update-distrib-+á¶œ _ Î· ğŸ˜ _ xâ€²) âŸ©
          (((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) , xâ€² â‰” ğŸ˜) +á¶œ (Î· , xâ€² â‰” Î· âŸ¨ xâ€² âŸ©)) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰¡âŸ¨ congâ‚‚ (Î» x y â†’ (x +á¶œ y) +á¶œ (âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²)) update-twice (update-self Î· xâ€²) âŸ©
          ((ğŸ˜á¶œ , xâ€² â‰” ğŸ˜) +á¶œ Î·) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰¡âŸ¨ cong (Î» x â†’ (x +á¶œ Î·) +á¶œ (âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²)) ğŸ˜á¶œ,â‰”ğŸ˜ âŸ©
          (ğŸ˜á¶œ +á¶œ Î·) +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-identityË¡ Î·) âŸ©
          Î· +á¶œ âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€²
            â‰ˆâŸ¨ +á¶œ-comm Î· _ âŸ©
          âˆ£Sâˆ£ Â·á¶œ ÏÎ´â€² +á¶œ Î· âˆ
    where
    xâ€² : Ptr n
    xâ€² = wkVar Ï x
    ÏÎ´ : Conâ‚˜ n
    ÏÎ´ = wká¶œ Ï Î´
    âˆ£Sâˆ£ : M
    âˆ£Sâˆ£ = âˆ£ S âˆ£
    lemmaâ‚€ : Î³ â‰¤á¶œ (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£ Â· âŒœ m âŒ) +á¶œ Î·
    lemmaâ‚€ = begin
      Î³                                   â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£Sâˆ£ Â·á¶œ ÏÎ´ +á¶œ Î·                      â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (inv-usage-var â–¸x))) âŸ©
      âˆ£Sâˆ£ Â·á¶œ wká¶œ Ï (ğŸ˜á¶œ , x â‰” âŒœ m âŒ) +á¶œ Î·  â‰¡âŸ¨ cong (Î» x â†’ âˆ£Sâˆ£ Â·á¶œ x +á¶œ Î·) (wkUsageVar Ï x)  âŸ©
      âˆ£Sâˆ£ Â·á¶œ (ğŸ˜á¶œ , xâ€² â‰” âŒœ m âŒ) +á¶œ Î·       â‰¡Ë˜âŸ¨ cong (_+á¶œ Î·) (update-distrib-Â·á¶œ ğŸ˜á¶œ âˆ£Sâˆ£ _ xâ€²) âŸ©
      (âˆ£Sâˆ£ Â·á¶œ ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£ Â· âŒœ m âŒ) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-congÊ³ (update-congË¡ (Â·á¶œ-zeroÊ³ âˆ£Sâˆ£)) âŸ©
      (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£ Â· âŒœ m âŒ) +á¶œ Î·        âˆ
      where
      open RPo â‰¤á¶œ-poset
    âˆ£Sâˆ£mâ‰¡âˆ£Sâˆ£ : âˆ£Sâˆ£ Â· âŒœ m âŒ â‰¡ âˆ£Sâˆ£
    âˆ£Sâˆ£mâ‰¡âˆ£Sâˆ£ = case singleton m of Î» where
      (ğŸ˜áµ , refl) â†’ trans (Â·-zeroÊ³ _) (sym (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤))
      (ğŸ™áµ , refl) â†’ Â·-identityÊ³ _
    lemmaâ‚ : Î³ â‰¤á¶œ (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î·
    lemmaâ‚ rewrite sym âˆ£Sâˆ£mâ‰¡âˆ£Sâˆ£ = lemmaâ‚€
    lemmaâ‚‚ : Î³ âŸ¨ xâ€² âŸ© - âˆ£Sâˆ£ â‰¤ Î· âŸ¨ xâ€² âŸ©
    lemmaâ‚‚ = begin
      Î³ âŸ¨ xâ€² âŸ©                        â‰¤âŸ¨ lookup-monotone xâ€² lemmaâ‚ âŸ©
      ((ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) +á¶œ Î·) âŸ¨ xâ€² âŸ©     â‰¡âŸ¨ lookup-distrib-+á¶œ (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) Î· xâ€² âŸ©
      (ğŸ˜á¶œ , xâ€² â‰” âˆ£Sâˆ£) âŸ¨ xâ€² âŸ© + Î· âŸ¨ xâ€² âŸ©  â‰¡âŸ¨ cong (_+ Î· âŸ¨ xâ€² âŸ©) (update-lookup ğŸ˜á¶œ xâ€²) âŸ©
      âˆ£Sâˆ£ + Î· âŸ¨ xâ€² âŸ©                    â‰ˆâŸ¨ +-comm âˆ£Sâˆ£ _ âŸ©
      Î· âŸ¨ xâ€² âŸ© + âˆ£Sâˆ£                    âˆ
      where
      open RPo â‰¤-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (appâ‚• {p} {Ï} {S}) =
    case inv-usage-app â–¸t of Î»
      (invUsageApp {Î´ = Î´â€²} {(Î·â€²)} â–¸t â–¸u Î´â‰¤) â†’
    _ , _ , _ , _ , â–¸H , â–¸t , (âˆ˜â‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
      , subst (_ â‰¤áµ_) (sym (Â·-identityÊ³ _)) mâ‰¤
      , (begin
        Î³                                                      â‰¤âŸ¨ Î³â‰¤ âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                   â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Î´â€² +á¶œ p Â·á¶œ Î·â€²) +á¶œ Î·                     â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï Î´â€² +á¶œ wká¶œ Ï (p Â·á¶œ Î·â€²)) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congË¡ (wk-Â·á¶œ Ï))) âŸ©
        âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï Î´â€² +á¶œ p Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î·               â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
        (âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î·      â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î·â€² +á¶œ Î·       â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-comm _ _) âŸ©
        (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î·â€² âˆ)
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (fstâ‚• {Ï} {S}) =
    case inv-usage-fst â–¸t of Î»
      (invUsageFst {Î´ = Î´â€²} m eq â–¸t Î´â‰¤ mp-cond) â†’
    _ , _ , _ , _
      , â–¸H , â–¸t , (fstâ‚‘ mp-cond , mâ‰¤) âˆ™ â–¸S
      , subst (_ â‰¤áµ_) (sym (Â·-identityÊ³ _)) mâ‰¤
      , (begin
          Î³                                           â‰¤âŸ¨ Î³â‰¤ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·                      â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ          â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (sndâ‚• {Ï} {S}) =
    case inv-usage-snd â–¸t of Î»
      (invUsageSnd {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
   _ , _ , _ , _ , â–¸H , â–¸t , (sndâ‚‘ , mâ‰¤) âˆ™ â–¸S
     , subst (_ â‰¤áµ_) (sym (Â·-identityÊ³ _)) mâ‰¤
     , (begin
         Î³                                            â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                        â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·                       â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
         (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ           â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
   where
   open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (prodrecâ‚• {r} {p} {u} {Ï} {S}) =
    case inv-usage-prodrec â–¸t of Î»
      (invUsageProdrec {Î´ = Î´â€²} {Î· = Î·â€²} â–¸t â–¸u _ ok Î´â‰¤) â†’
    _ , _ , _ , _
      , â–¸H , â–¸t
      , (prodrecâ‚‘ â–¸u ok , mâ‰¤) âˆ™ â–¸S
      , â‰¤áµ-Â· mâ‰¤
      , (begin
         Î³                                                   â‰¤âŸ¨ Î³â‰¤ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (r Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
         âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï (r Â·á¶œ Î´â€²) +á¶œ wká¶œ Ï Î·â€²) +á¶œ Î·          â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ âˆ£ S âˆ£ _ _) âŸ©
         (âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (r Â·á¶œ Î´â€²) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
         âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (r Â·á¶œ Î´â€²) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€² +á¶œ Î·   â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congË¡ (wk-Â·á¶œ Ï)) (+á¶œ-comm _ Î·) âŸ©
         âˆ£ S âˆ£ Â·á¶œ r Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€²     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-assoc âˆ£ S âˆ£ r _) âŸ©
         (âˆ£ S âˆ£ Â· r) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€²    âˆ)
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (natrecâ‚• {p} {r} {s} {Ï} {S}) =
    case inv-usage-natrec â–¸t of Î» {
      (invUsageNatrec {Î´ = Î´â€²} {Î· = Î·â€²} {Î¸} â–¸z â–¸s â–¸n â–¸A Î´â‰¤nr P) â†’
    case P of Î» {
      (invUsageNatrecNoNr _ _ _ _) â†’ âŠ¥-elim not-nr-and-no-nr ;
      (invUsageNatrecNr â¦ƒ (d-nrâ€²) â¦„) â†’
    case Dedicated-nr-propositional d-nr d-nrâ€² of Î» {
      refl â†’
    _ , _ , _ , _ , â–¸H , â–¸n , (natrecâ‚‘ â–¸z â–¸s â–¸A , mâ‰¤) âˆ™ â–¸S
      , subst (_â‰¤áµ _) (â‰¢ğŸ˜â†’áµÂ·â‰¡ nrâ‚‚â‰¢ğŸ˜) (â‰¤áµ-Â· mâ‰¤) , (begin
      Î³                                                                        â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                                    â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤nr)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² Î¸) +á¶œ Î·                                     â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï nrá¶œ-factoring)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrâ‚‚ p r Â·á¶œ Î¸ +á¶œ nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) +á¶œ Î·                    â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
      âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)) +á¶œ Î·          â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
      (âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrâ‚‚ p r Â·á¶œ Î¸) +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) +á¶œ Î·   â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congË¡ (wk-Â·á¶œ Ï)) (+á¶œ-comm _ _) âŸ©
      âˆ£ S âˆ£ Â·á¶œ (nrâ‚‚ p r Â·á¶œ wká¶œ Ï Î¸) +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ)   â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-assoc _ _ _) âŸ©
      (âˆ£ S âˆ£ Â· nrâ‚‚ p r) Â·á¶œ wká¶œ Ï Î¸ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (nrá¶œ p r Î´â€² Î·â€² ğŸ˜á¶œ) âˆ)}}}
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (unitrecâ‚• {p} {Ï} {S} no-Î·) =
    case inv-usage-unitrec â–¸t of Î»
      (invUsageUnitrec {Î´ = Î´â€²} {Î· = Î·â€²} â–¸t â–¸u _ ok Î´â‰¤) â†’
    _ , _ , _ , _ , â–¸H
      , â–¸t
      , (unitrecâ‚‘ â–¸u ok no-Î· , mâ‰¤) âˆ™ â–¸S
      , â‰¤áµ-Â· mâ‰¤
      , (begin
          Î³                                                  â‰¤âŸ¨ Î³â‰¤ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                              â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â€² +á¶œ Î·â€²) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï (p Â·á¶œ Î´â€²) +á¶œ wká¶œ Ï Î·â€²) +á¶œ Î·        â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (wk-Â·á¶œ Ï))) âŸ©
          âˆ£ S âˆ£  Â·á¶œ (p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ wká¶œ Ï Î·â€²) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
          (âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€²) +á¶œ Î· â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
          âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€² +á¶œ Î·   â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
          (âˆ£ S âˆ£ Â· p) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î·â€²  âˆ)
    where
    open RPo â‰¤á¶œ-poset

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (emptyrecâ‚• {p} {Ï} {S}) =
    case inv-usage-emptyrec â–¸t of Î» {
      (invUsageEmptyrec {Î´ = Î´â€²} â–¸t _ ok Î´â‰¤) â†’
    _ , _ , _ , _ , â–¸H , â–¸t , (emptyrecâ‚‘ ok , mâ‰¤) âˆ™ â–¸S
      , â‰¤áµ-Â· mâ‰¤ , (begin
        Î³                                              â‰¤âŸ¨ Î³â‰¤ âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (p Â·á¶œ Î´â€²) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congË¡ (wk-Â·á¶œ Ï)) (â‰ˆá¶œ-sym (+á¶œ-identityÊ³ Î·)) âŸ©
        âˆ£ S âˆ£ Â·á¶œ p Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ              â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
        (âˆ£ S âˆ£ Â· p) Â·á¶œ wkConâ‚˜ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)}
    where
    open RPo â‰¤á¶œ-poset


  â–¸-â‡’â‚™ (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (Jâ‚• {H}) = â–¸-â‡’â‚™-J â–¸H â–¸S mâ‰¤ Î³â‰¤ (inv-usage-J â–¸t)
    where
    em : Erased-matches
    em = erased-matches-for-J ğŸ™áµ
    open RPo â‰¤á¶œ-poset
    â–¸-â‡’â‚™-J-ğŸ˜áµ : âˆ€ {Î³â‚ Î³â‚‚ ok}
              â†’ Î³ â–¸Ê° H â†’ Î· â–¸Ë¢ S â†’ âˆ£ S âˆ£ â‰¡ ğŸ˜ â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·
              â†’ Î³â‚ â–¸[ ğŸ˜áµ[ ok ] ] u â†’ Î³â‚‚ â–¸[ ğŸ˜áµ[ ok ] ] w
              â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] âŸ¨ H , w , Ï , Jâ‚‘ p q A t B u v Ï âˆ™ S âŸ©)
    â–¸-â‡’â‚™-J-ğŸ˜áµ {Î³} {Î·} {S} {Ï} {Î´} {p} {q} {Î³â‚} {Î³â‚‚} â–¸H â–¸S âˆ£Sâˆ£â‰¡ğŸ˜ Î³â‰¤ â–¸u â–¸w =
      _ , _ , _ , _ , â–¸H , â–¸w
        , (Jâ‚‘ â–¸u , (subst (_ â‰¤áµ_) (sym âˆ£Sâˆ£â‰¡ğŸ˜) ğŸ˜áµâ‰¤áµğŸ˜)) âˆ™ â–¸S
        , subst (_ â‰¤áµ_) (sym (trans (Â·-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜) (Â·-zeroË¡ _))) ğŸ˜áµâ‰¤áµğŸ˜
        , (begin
            Î³                                                           â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                                    â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                                        â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜á¶œ +á¶œ Î·                                                     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-identityÊ³ _) âŸ©
            (ğŸ˜á¶œ +á¶œ ğŸ˜á¶œ) +á¶œ Î·                                             â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
            ğŸ˜á¶œ +á¶œ ğŸ˜á¶œ +á¶œ Î·                                               â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-comm _ _) âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ ğŸ˜á¶œ                                               â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-zeroË¡ _) (+á¶œ-congË¡ (Â·á¶œ-zeroË¡ _)) âŸ©
            ğŸ˜ Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ ğŸ˜ Â·á¶œ wká¶œ Ï Î³â‚                         â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-zeroË¡ _)) (+á¶œ-congË¡ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜)) âŸ©
            (ğŸ˜ Â· âˆ£âˆ£áµ‰-J em p q) Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜)) âŸ©
            (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-J em p q) Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚ âˆ)

    â–¸-â‡’â‚™-J : Î³ â–¸Ê° H â†’ Î· â–¸Ë¢ S â†’ m â‰¤áµ âˆ£ S âˆ£ â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· â†’ InvUsageJ Î´ m p q A t B u v w
           â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] âŸ¨ H , w , Ï , Jâ‚‘ p q A t B u v Ï âˆ™ S âŸ©)
    â–¸-â‡’â‚™-J {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJ {Î³â‚„} {Î³â‚†} e eâ€² _ _ _ â–¸u _ â–¸w Î´â‰¤) =
      â–¸-â‡’â‚™-J-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u â–¸w
    â–¸-â‡’â‚™-J {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJ {Î³â‚‚} {Î³â‚ƒ} {Î³â‚„} {Î³â‚…} {Î³â‚†} e eâ€² _ _ _ â–¸u _ â–¸w Î´â‰¤) rewrite âˆ£âˆ£áµ‰-J-Ï‰ e eâ€² =
      _ , _ , _ , _ , â–¸H , â–¸w , (Jâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
        , ğŸ™áµâ‰¤áµ
        , (begin
            Î³                                                         â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚‚ +á¶œ Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚„ +á¶œ Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (Â·á¶œ-distribË¡-+á¶œ Ï‰ _ _))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ Î³â‚„ +á¶œ Ï‰ Â·á¶œ (Î³â‚… +á¶œ Î³â‚†)) +á¶œ Î·           â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (+á¶œ-monotoneÊ³ Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ Î³â‚„ +á¶œ Ï‰ Â·á¶œ Î³â‚†) +á¶œ Î·                   â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-+á¶œ Ï)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï (Ï‰ Â·á¶œ Î³â‚„) +á¶œ wká¶œ Ï (Ï‰ Â·á¶œ Î³â‚†)) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-cong (wk-Â·á¶œ Ï) (wk-Â·á¶œ Ï))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚†) +á¶œ Î·             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (+á¶œ-monotoneË¡ (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (ğŸ™ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚†) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congÊ³ (Â·á¶œ-identityË¡ _))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (wká¶œ Ï Î³â‚„ +á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚†) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
            (âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚†) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-congÊ³ (+á¶œ-comm _ _) âŸ©
            (âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚† +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
            âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚† +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Î·           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
            (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ Ï Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„          âˆ)
    â–¸-â‡’â‚™-J {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJâ‚€â‚ {Î³â‚„} {Î³â‚†} e _ _ _ _ _ â–¸u _ â–¸w Î´â‰¤) =
      â–¸-â‡’â‚™-J-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u (â–¸-cong ğŸ˜áµ?â‰¡ğŸ˜áµ â–¸w)
    â–¸-â‡’â‚™-J {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJâ‚€â‚ {Î³â‚ƒ} {Î³â‚„} {Î³â‚†} eâ‰¡some refl refl _ _ _ â–¸u _ â–¸w Î´â‰¤) rewrite âˆ£âˆ£áµ‰-J-someâ‚€â‚€ eâ‰¡some =
      _ , _ , _ , _ , â–¸H , â–¸w , (Jâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
        , subst (ğŸ˜áµ? â‰¤áµ_) (sym (Â·-zeroÊ³  _)) ğŸ˜áµ?â‰¤áµğŸ˜
        , (begin
            Î³                                                   â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                            â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„)) +á¶œ Î·             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï (Ï‰ Â·á¶œ Î³â‚„) +á¶œ Î·                     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï (ğŸ™ Â·á¶œ Î³â‚„) +á¶œ Î·                     â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (Â·á¶œ-identityË¡ _))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„ +á¶œ Î·                            â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„                            â‰ˆË˜âŸ¨ +á¶œ-identityË¡ _ âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„                      â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„        â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) âŸ©
            (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wkConâ‚˜ Ï Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ âˆ)
    â–¸-â‡’â‚™-J {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJâ‚€â‚‚ eâ‰¡all _ _ _ â–¸u _ â–¸w Î´â‰¤) =
      â–¸-â‡’â‚™-J-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u (â–¸-cong ğŸ˜áµ?â‰¡ğŸ˜áµ â–¸w)
    â–¸-â‡’â‚™-J {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} {p} {q} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageJâ‚€â‚‚ {Î³â‚„} {Î³â‚†} eâ‰¡all _ _ _ â–¸u _ â–¸w Î´â‰¤) rewrite âˆ£âˆ£áµ‰-J-all {p = p} {q = q} eâ‰¡all =
      _ , _ , _ , _ , â–¸H , â–¸w , (Jâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
        , subst (ğŸ˜áµ? â‰¤áµ_) (sym (Â·-zeroÊ³  _)) ğŸ˜áµ?â‰¤áµğŸ˜
        , (begin
            Î³                                                    â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„ +á¶œ Î·                            â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„                            â‰ˆË˜âŸ¨ +á¶œ-identityË¡ _ âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„                      â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î³â‚„        â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) âŸ©
            (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wkConâ‚˜ Ï Î³â‚† +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ âˆ)

  â–¸-â‡’â‚™ (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (Kâ‚• {H}) = â–¸-â‡’â‚™-K â–¸H â–¸S mâ‰¤ Î³â‰¤ (inv-usage-K â–¸t)
    where
    em : Erased-matches
    em = erased-matches-for-K ğŸ™áµ
    open RPo â‰¤á¶œ-poset
    â–¸-â‡’â‚™-K-ğŸ˜áµ : âˆ€ {Î³â‚ Î³â‚‚ ok}
              â†’ Î³ â–¸Ê° H â†’ Î· â–¸Ë¢ S â†’ âˆ£ S âˆ£ â‰¡ ğŸ˜ â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·
              â†’ Î³â‚ â–¸[ ğŸ˜áµ[ ok ] ] u â†’ Î³â‚‚ â–¸[ ğŸ˜áµ[ ok ] ] v
              â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] âŸ¨ H , v , Ï , Kâ‚‘ p A t B u Ï âˆ™ S âŸ©)
    â–¸-â‡’â‚™-K-ğŸ˜áµ {Î³} {Î·} {S} {Ï} {Î´} {p} {Î³â‚} {Î³â‚‚} â–¸H â–¸S âˆ£Sâˆ£â‰¡ğŸ˜ Î³â‰¤ â–¸u â–¸v =
      _ , _ , _ , _ , â–¸H , â–¸v
        , (Kâ‚‘ â–¸u , (subst (_ â‰¤áµ_) (sym âˆ£Sâˆ£â‰¡ğŸ˜) ğŸ˜áµâ‰¤áµğŸ˜)) âˆ™ â–¸S
        , subst (_ â‰¤áµ_) (sym (trans (Â·-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜) (Â·-zeroË¡ _))) ğŸ˜áµâ‰¤áµğŸ˜
        , (begin
            Î³                                                         â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î´ +á¶œ Î·                                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜á¶œ +á¶œ Î·                                                   â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (+á¶œ-identityÊ³ _) âŸ©
            (ğŸ˜á¶œ +á¶œ ğŸ˜á¶œ) +á¶œ Î·                                           â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
            ğŸ˜á¶œ +á¶œ ğŸ˜á¶œ +á¶œ Î·                                             â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-comm _ _) âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ ğŸ˜á¶œ                                             â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-zeroË¡ _) (+á¶œ-congË¡ (Â·á¶œ-zeroË¡ _)) âŸ©
            ğŸ˜ Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ ğŸ˜ Â·á¶œ wká¶œ Ï Î³â‚                       â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-zeroË¡ _)) (+á¶œ-congË¡ (Â·á¶œ-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜)) âŸ©
            (ğŸ˜ Â· âˆ£âˆ£áµ‰-K em p) Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚     â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-congÊ³ âˆ£Sâˆ£â‰¡ğŸ˜)) âŸ©
            (âˆ£ S âˆ£ Â· âˆ£âˆ£áµ‰-K em p) Â·á¶œ wká¶œ Ï Î³â‚‚ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚ âˆ)
    â–¸-â‡’â‚™-K : Î³ â–¸Ê° H â†’ Î· â–¸Ë¢ S â†’ m â‰¤áµ âˆ£ S âˆ£ â†’ Î³ â‰¤á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· â†’ InvUsageK Î´ m p A t B u v
           â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] âŸ¨ H , v , Ï , Kâ‚‘ p A t B u Ï âˆ™ S âŸ©)
    â–¸-â‡’â‚™-K {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageK _ _ _ _ _ â–¸u â–¸v _) =
      â–¸-â‡’â‚™-K-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u â–¸v
    â–¸-â‡’â‚™-K {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} {p} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageK {Î³â‚‚} {Î³â‚ƒ} {Î³â‚„} {Î³â‚…} e eâ€² _ _ _ â–¸u â–¸v Î´â‰¤) rewrite âˆ£âˆ£áµ‰-K-Ï‰ e eâ€² =
      _ , _ , _ , _ , â–¸H , â–¸v , (Kâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S , ğŸ™áµâ‰¤áµ
        , (begin
            Î³                                                         â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                     â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚‚ +á¶œ Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·          â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (wk-Â·á¶œ Ï)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï (Î³â‚„ +á¶œ Î³â‚…)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (+á¶œ-comm _ _)))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï (Î³â‚… +á¶œ Î³â‚„)) +á¶œ Î·                      â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-+á¶œ Ï))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ (wká¶œ Ï Î³â‚… +á¶œ wká¶œ Ï Î³â‚„)) +á¶œ Î·                â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (Â·á¶œ-distribË¡-+á¶œ _ _ _)) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚„) +á¶œ Î·             â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (+á¶œ-monotoneÊ³ (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ ğŸ™ Â·á¶œ wká¶œ Ï Î³â‚„) +á¶œ Î·             â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-identityË¡ _))) âŸ©
            âˆ£ S âˆ£ Â·á¶œ (Ï‰ Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ wká¶œ Ï Î³â‚„) +á¶œ Î·                  â‰ˆâŸ¨ +á¶œ-congÊ³ (Â·á¶œ-distribË¡-+á¶œ _ _ _) âŸ©
            (âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„) +á¶œ Î·         â‰ˆâŸ¨ +á¶œ-assoc _ _ _ âŸ©
            âˆ£ S âˆ£ Â·á¶œ Ï‰ Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Î·           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-assoc _ _ _) (+á¶œ-comm _ _) âŸ©
            (âˆ£ S âˆ£ Â· Ï‰) Â·á¶œ wká¶œ Ï Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„          âˆ)
    â–¸-â‡’â‚™-K {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageKâ‚€â‚ _ _ _ _ _ â–¸u â–¸v _) =
      â–¸-â‡’â‚™-K-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u (â–¸-cong ğŸ˜áµ?â‰¡ğŸ˜áµ â–¸v)
    â–¸-â‡’â‚™-K {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} {p} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageKâ‚€â‚ {Î³â‚ƒ} {Î³â‚„} {Î³â‚…} eâ‰¡some refl _ _ _ â–¸u â–¸v Î´â‰¤) rewrite âˆ£âˆ£áµ‰-K-someâ‚€ eâ‰¡some =
      _ , _ , _ , _ , â–¸H , â–¸v , (Kâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
        , subst (ğŸ˜áµ? â‰¤áµ_) (sym (Â·-zeroÊ³  _)) ğŸ˜áµ?â‰¤áµğŸ˜
        , (begin
            Î³                                                    â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´                                â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ (Î³â‚ƒ +á¶œ Î³â‚„))                â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Ï‰Â·á¶œ+á¶œâ‰¤Ï‰Â·á¶œÊ³)) âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (Ï‰ Â·á¶œ Î³â‚„)                        â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï (Â·á¶œ-monotoneË¡ Ï‰â‰¤ğŸ™))) âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï (ğŸ™ Â·á¶œ Î³â‚„)                        â‰ˆâŸ¨ +á¶œ-congË¡ (Â·á¶œ-congË¡ (wk-â‰ˆá¶œ Ï (Â·á¶œ-identityË¡ _))) âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„                               â‰ˆË˜âŸ¨ +á¶œ-identityË¡ _ âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„                         â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„           â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) âŸ©
            (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wkConâ‚˜ Ï Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ âˆ)
    â–¸-â‡’â‚™-K {m = ğŸ˜áµ} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageKâ‚€â‚‚ _ _ _ _ â–¸u â–¸v _) =
      â–¸-â‡’â‚™-K-ğŸ˜áµ â–¸H â–¸S (ğŸ˜áµâ‰¤áµpâ†’pâ‰¡ğŸ˜ mâ‰¤) Î³â‰¤ â–¸u (â–¸-cong ğŸ˜áµ?â‰¡ğŸ˜áµ â–¸v)
    â–¸-â‡’â‚™-K {Î³} {Î·} {S} {m = ğŸ™áµ} {Ï} {Î´} {p} â–¸H â–¸S mâ‰¤ Î³â‰¤ (invUsageKâ‚€â‚‚ {Î³â‚„} {Î³â‚…} eâ‰¡all _ _ _ â–¸u â–¸v Î´â‰¤) rewrite âˆ£âˆ£áµ‰-K-all {p = p} eâ‰¡all =
      _ , _ , _ , _ , â–¸H , â–¸v , (Kâ‚‘ â–¸u , mâ‰¤) âˆ™ â–¸S
        , subst (ğŸ˜áµ? â‰¤áµ_) (sym (Â·-zeroÊ³  _)) ğŸ˜áµ?â‰¤áµğŸ˜
        , (begin
            Î³                                                    â‰¤âŸ¨ Î³â‰¤ âŸ©
            âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                                â‰ˆâŸ¨ +á¶œ-comm _ _ âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´                                â‰¤âŸ¨ +á¶œ-monotoneÊ³ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
            Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„                               â‰ˆË˜âŸ¨ +á¶œ-identityË¡ _  âŸ©
            ğŸ˜á¶œ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„                         â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-zeroË¡ _) âŸ©
            ğŸ˜ Â·á¶œ wkConâ‚˜ Ï Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„           â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) âŸ©
            (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wkConâ‚˜ Ï Î³â‚… +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î³â‚„ âˆ)

  â–¸-â‡’â‚™ {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) ([]-congâ‚• {Ï} {S}) =
    case inv-usage-[]-cong â–¸t of Î»
      (invUsage-[]-cong {Î³â‚„} _ _ _ â–¸v ok Î´â‰¤) â†’
    _ , _ , _ , _ , â–¸H , â–¸v , ([]-congâ‚‘ ok , mâ‰¤) âˆ™ â–¸S
      , subst (ğŸ˜áµ? â‰¤áµ_) (sym (Â·-zeroÊ³ _)) ğŸ˜áµ?â‰¤áµğŸ˜
      , (begin
          Î³                                           â‰¤âŸ¨ Î³â‰¤ âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                       â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
          âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï ğŸ˜á¶œ +á¶œ Î·                      â‰¡âŸ¨ cong (Î» x â†’ _ Â·á¶œ x +á¶œ _) (wk-ğŸ˜á¶œ Ï) âŸ©
          âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ +á¶œ Î·                            â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-zeroÊ³ _) (â‰ˆá¶œ-sym (+á¶œ-identityÊ³ _)) âŸ©
          ğŸ˜á¶œ +á¶œ Î· +á¶œ ğŸ˜á¶œ                               â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-zeroË¡ _) (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
          ğŸ˜ Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ           â‰ˆË˜âŸ¨ +á¶œ-congÊ³ (Â·á¶œ-congÊ³ (Â·-zeroÊ³ _)) âŸ©
          (âˆ£ S âˆ£ Â· ğŸ˜) Â·á¶œ wká¶œ Ï Î³â‚„ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
    where
    open RPo â‰¤á¶œ-poset

opaque

  â–¸-â‡’â‚› : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸[ m ] s) (d : s â‡’â‚› sâ€²) â†’ âˆƒâ‚ƒ (_â¨¾_â¨¾_â–¸[ m ] sâ€²)
  â–¸-â‡’â‚› {Î³} {Î´} {Î·} (â–¸H , â–¸t , â–¸S , mâ‰¤ , Î³â‰¤) (sucâ‚• {Ï} {k} x) =
    case inv-usage-suc â–¸t of Î»
      (invUsageSuc {Î´ = Î´â€²} â–¸t Î´â‰¤) â†’
    _ , _ , _ , â–¸H , â–¸t , (sucâ‚‘ , mâ‰¤) âˆ™ â–¸S
      , subst (_ â‰¤áµ_) (sym (Â·-identityÊ³ _)) mâ‰¤ , (begin
      Î³ â‰¤âŸ¨ Î³â‰¤ âŸ©
      âˆ£ sucâ‚› k âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                            â‰¤âŸ¨ +á¶œ-monotoneË¡ (Â·á¶œ-monotoneÊ³ (wk-â‰¤á¶œ Ï Î´â‰¤)) âŸ©
      âˆ£ sucâ‚› k âˆ£ Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î·                           â‰ˆË˜âŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
      (âˆ£ sucâ‚› k âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ ğŸ˜á¶œ               â‰ˆË˜âŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
      (âˆ£ sucâ‚› k âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´â€² +á¶œ Î· +á¶œ âˆ£ sucâ‚› k âˆ£ Â·á¶œ ğŸ˜á¶œ âˆ)
    where
    open RPo â‰¤á¶œ-poset
  â–¸-â‡’â‚› {Î³} {Î´} (â–¸H , â–¸t , _âˆ™_ {Î³ = Î·} (â–¸e , mâ€²â‰¤) â–¸S , mâ‰¤ , Î³â‰¤) (numâ‚• {Ï} {S} x) =
    case â–¸e of Î» {
      sucâ‚‘ â†’
    _ , _ , _ , â–¸H , sucâ‚˜ â–¸t , â–¸S
      , subst (_ â‰¤áµ_) (Â·-identityÊ³ _) mâ‰¤ , (begin
      Î³                                          â‰¤âŸ¨ Î³â‰¤ âŸ©
      (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ âˆ£ S âˆ£ Â·á¶œ ğŸ˜á¶œ â‰ˆâŸ¨ +á¶œ-congË¡ (+á¶œ-congË¡ (Â·á¶œ-zeroÊ³ _)) âŸ©
      (âˆ£ S âˆ£ Â· ğŸ™) Â·á¶œ wká¶œ Ï Î´ +á¶œ Î· +á¶œ ğŸ˜á¶œ          â‰ˆâŸ¨ +á¶œ-cong (Â·á¶œ-congÊ³ (Â·-identityÊ³ _)) (+á¶œ-identityÊ³ Î·) âŸ©
      âˆ£ S âˆ£ Â·á¶œ wká¶œ Ï Î´ +á¶œ Î·                      âˆ) }
    where
    open RPo â‰¤á¶œ-poset


opaque

  -- Well-resourced states evaluate to well-resourced states

  â–¸-â‡’ : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸[ m ] s) (d : s â‡’ sâ€²) â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] sâ€²)
  â–¸-â‡’ â–¸s (â‡’â‚™ d) = â–¸-â‡’â‚™ â–¸s d
  â–¸-â‡’ â–¸s (â‡’áµ¥ d) = â–¸-â‡’áµ¥ â–¸s d
  â–¸-â‡’ â–¸s (â‡’â‚› d) =
    case â–¸-â‡’â‚› â–¸s d of Î»
      (Î³ , Î´ , Î· , â–¸s) â†’
    Î³ , Î´ , Î· , _ , â–¸s

opaque

  â–¸-â‡’* : (â–¸s : Î³ â¨¾ Î´ â¨¾ Î· â–¸[ m ] s) (d : s â‡’* sâ€²) â†’ âˆƒâ‚„ (_â¨¾_â¨¾_â–¸[_] sâ€²)
  â–¸-â‡’* â–¸s id =
    _ , _ , _ , _ , â–¸s
  â–¸-â‡’* â–¸s (d â‡¨ dâ€²) =
    case â–¸-â‡’ â–¸s d of Î»
      (_ , _ , _ , _ , â–¸sâ€²) â†’
    â–¸-â‡’* â–¸sâ€² dâ€²
